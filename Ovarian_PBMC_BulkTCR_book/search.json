[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Ovarian Neovax: PBMC BulkTCR Analysis",
    "section": "",
    "text": "Introduction\nThis is a book that contains all code to reproduce figures related to bulkTCRseq analysis of PBMC data associated with Sellars, et al (2026)\nThe code is identical to the code utilized to generate final figures for the manuscript. Small differences may arise in style and formatting of the visualization.",
    "crumbs": [
      "Introduction"
    ]
  },
  {
    "objectID": "index.html#immune-selective-pressure-by-personal-neoantigen-vaccines-shapes-response-in-high-grade-serous-ovarian-cancer",
    "href": "index.html#immune-selective-pressure-by-personal-neoantigen-vaccines-shapes-response-in-high-grade-serous-ovarian-cancer",
    "title": "Ovarian Neovax: PBMC BulkTCR Analysis",
    "section": "Immune selective pressure by personal neoantigen vaccines shapes response in high-grade serous ovarian cancer",
    "text": "Immune selective pressure by personal neoantigen vaccines shapes response in high-grade serous ovarian cancer\nMacLean C. Sellars, Jessica Frank, Bohoon Shim, Allison Vanasse, Cleo Forman, Chloe R. Tu, Kyle Tabata, Haley E. Sax, Kan Xiong, Catherine Song, Ruolin Liu, Vipheaviny Chea, Wesley Lu, Micah Rickles-Young, Amit Sud, Oriol Olive, Haley Greenslade, Carrie Cibulskis, Nir Hacohen, Sarah Hill, Shuqiang Li, Kenneth J. Livak, Edward F. Fritsch, Rebecca Porter, Carolyn Krasner, Elizabeth Stover Giacomo Oliveira,Viktor Adalsteinsson, Jeremy M. Simon, Patrick A. Ott, Ursula Matulonis, Derin B. Keskin,Catherine J. Wu, Panos Konstantinopoulos\n\nAbstract\nAdjuvant personalized cancer vaccines (PCV) targeting neoantigens are of increasing interest across malignancies. Herein, we report the results of a first-in-disease phase I clinical trial testing a PCV in women with high-grade serous ovarian cancer (HGSOC), a low mutation burden tumor (NCT04024878). ‘NeoVax’ consisted of pools of synthetic long peptides admixed with the immunostimulant polyICLC, and was combined with anti-PD1 antibody for platinum-sensitive HGSOC following standard-of-care (SOC) platinum doublet chemotherapy. Vaccines were generated successfully for all 10 treated patients, with &gt;70% selected targets detectable by non-invasive cell-free DNA analysis despite prolonged prior exposure to SOC therapy. Clinical benefit was observed in 6 of 10 patients and was associated with broader immune responses. Multiple tumor- and vaccine-specific T cell clonotypes were detected in blood and tumor following vaccination. Importantly, tumor clones detected in resistant tumor lesions arose from diverse mechanisms, indicative of immunoselective pressure imposed by vaccine treatment. Our results reveal an interplay between the breadth of antigens presented by the tumor and resulting immunity, which may dictate clinical efficacy following vaccination.",
    "crumbs": [
      "Introduction"
    ]
  },
  {
    "objectID": "Data_Processing.html",
    "href": "Data_Processing.html",
    "title": "1  PBMCs: Data Loading and Compilation",
    "section": "",
    "text": "1.1 Setting up Dataframe for visualization\n# rename columns to a same week+days format \n\nrename_columns &lt;- function(df) {\n  colnames(df) &lt;- colnames(df) %&gt;%\n    gsub(\"total_umi_PreL_W0\", \"Prevaccine_umi\", .) %&gt;%\n    gsub(\"total_umi_fraction_PreL_W0\", \"Prevaccine_umi_fraction\", .) %&gt;%\n    gsub(\"total_umi_L2_W14\", \"Postvaccine_umi\", .) %&gt;%\n    gsub(\"total_umi_fraction_L2_W14\", \"Postvaccine_umi_fraction\", .) %&gt;%\n    gsub(\"total_umi_L3_W22|total_umi_W24\", \"Postnivo_umi\", .) %&gt;%\n    gsub(\"total_umi_fraction_L3_W22|total_umi_fraction_W24\", \"Postnivo_umi_fraction\", .) %&gt;%\n    gsub(\"total_umi_w00\", \"Prevaccine_umi\", .) %&gt;%\n    gsub(\"total_umi_fraction_w00\", \"Prevaccine_umi_fraction\", .) %&gt;%\n    gsub(\"total_umi_w14\", \"Postvaccine_umi\", .) %&gt;%\n    gsub(\"total_umi_fraction_w14\", \"Postvaccine_umi_fraction\", .) %&gt;%\n    gsub(\"total_umi_w22\", \"Postnivo_umi\", .) %&gt;%\n    gsub(\"total_umi_fraction_w22\", \"Postnivo_umi_fraction\", .) %&gt;%\n    gsub(\"total_umi_W16\", \"w16_umi\", .) %&gt;%\n    gsub(\"total_umi_fraction_W16\", \"w16_umi_fraction\", .) %&gt;%\n    gsub(\"total_umi_LATE_W40\", \"w40_umi\", .) %&gt;%\n    gsub(\"total_umi_fraction_LATE_W40\", \"w40_umi_fraction\", .) %&gt;%\n    gsub(\"total_umi_Pre-LL\", \"Prevaccine_umi\", .) %&gt;%\n    gsub(\"total_umi_fraction_Pre-LL\", \"Prevaccine_umi_fraction\", .) %&gt;%\n    gsub(\"total_umi_L2\", \"Postvaccine_umi\", .) %&gt;%\n    gsub(\"total_umi_fraction_L2\", \"Postvaccine_umi_fraction\", .) %&gt;%\n    gsub(\"total_umi_L3\", \"Postnivo_umi\", .) %&gt;%\n    gsub(\"total_umi_fraction_L3\", \"Postnivo_umi_fraction\", .) \n  return(df)\n}\n\n\n# Calculating LOD \ncalculate_LOD &lt;- function(vector) {\n  # Remove zero values before calculating min\n  min_nonzero &lt;- min(vector[vector &gt; 0], na.rm = TRUE)\n  \n  # Check if there are no nonzero values\n  if (is.infinite(min_nonzero)) {\n    return(NA)\n  }\n  # Calculate LOD\n  return(10^floor(log10(min_nonzero)))\n}\n\nmerge_patient_data &lt;- function(patient_id, base_path, timepoints, filename) {\n  \n  # subset for specific columns of interest\n  select_columns &lt;- function(file_path) {\n    df &lt;- read.csv(file_path, sep = \"\\t\")\n    df &lt;- df[,grep(\"total|aaSeqCDR3|vGene|jGene|aaImputedVDJSequence\", colnames(df))]\n    df$clonotype_id &lt;- paste(df$aaSeqCDR3, df$vGene, df$jGene, sep=\";\")\n    return(df)\n  }\n  # Helper function to select and rename columns\n  select_and_rename &lt;- function(df, suffix) {\n    colnames(df) &lt;- ifelse(colnames(df) != \"clonotype_id\",\n                           paste0(colnames(df), \"_\", suffix),\n                           colnames(df))\n    df &lt;- df[, grep(\"total|clonotype_id\", colnames(df))]\n    return(df)\n  }\n  \n  # Prepare file paths and suffixes\n  dataframes &lt;- lapply(timepoints, function(tp) {\n    file_path &lt;- file.path(base_path, paste0(filename, patient_id, \"_\", tp, \".TRB.tsv\"))\n    df &lt;- select_columns(file_path)\n    select_and_rename(df, tp)\n  })\n  \n  # Merge all dataframes\n  merged_df &lt;- Reduce(function(x, y) merge(x, y, by = \"clonotype_id\", all = TRUE), dataframes)\n  \n  # Replace NA values with 0\n  merged_df[is.na(merged_df)] &lt;- 0\n  \n  merged_df &lt;- rename_columns(merged_df)\n  \n  merged_df$Prevaccine_LOD &lt;- calculate_LOD(merged_df$Prevaccine_umi_fraction)\n  merged_df$Postvaccine_LOD &lt;- calculate_LOD(merged_df$Postvaccine_umi_fraction)\n  if (\"Postnivo_umi_fraction\" %in% colnames(merged_df)) {  # Fix: Should check for Postnivo_umi_fraction\n    merged_df$Postnivo_LOD &lt;- calculate_LOD(merged_df$Postnivo_umi_fraction)\n  }\n  if (\"w40_umi_fraction\" %in% colnames(merged_df)) {  # Fix: Should check for Postnivo_umi_fraction\n    merged_df$w40_LOD &lt;- calculate_LOD(merged_df$w40_umi_fraction)\n  }\n  if (patient_id == \"106\") {  # Fix: Should check for Postnivo_umi_fraction\n    merged_df$w16_LOD &lt;- calculate_LOD(merged_df$w16_umi_fraction)\n  }\n  \n  return(merged_df)\n}\n\nmerge_patient_data_rerun &lt;- function(patient_id, base_path, timepoints, filename) {\n  \n  select_columns &lt;- function(file_path) {\n    df &lt;- read.csv(file_path, sep = \"\\t\")\n    if (grepl(\"PT113\", file_path) & grepl(\"w00\", file_path)) {\n      # Removing the first replicate of PT113, had repliacte outlier issue just for this sample.\n      print(file_path)\n      df &lt;- df[,grep(\"total|aaSeqCDR3|vGene|jGene|aaImputedVDJSequence|uniqueUMICount\", colnames(df))]\n      # Identify columns for replicates 2, 3, and 4 (assuming \"total_\" is part of the column name)\n      umi_columns &lt;- grep(\"uniqueUMICount\", colnames(df))\n      # Replace the 'total' column with the sum of UMIs from replicates 2, 3, and 4\n      df$total_umi &lt;- rowSums(df[, umi_columns[2:4]], na.rm = TRUE)\n      df$total_umi_fraction &lt;- df$total_umi/sum(df$total_umi)\n    }\n    df &lt;- df[,grep(\"total|aaSeqCDR3|vGene|jGene|aaImputedVDJSequence\", colnames(df))]\n    df$clonotype_id &lt;- paste(df$aaSeqCDR3, df$vGene, df$jGene, sep=\";\")\n    return(df)\n  }\n  # Helper function to select and rename columns\n  select_and_rename &lt;- function(df, suffix) {\n    colnames(df) &lt;- ifelse(colnames(df) != \"clonotype_id\",\n                           paste0(colnames(df), \"_\", suffix),\n                           colnames(df))\n    df &lt;- df[, grep(\"total|clonotype_id\", colnames(df))]\n    return(df)\n  }\n  \n  # Prepare file paths and suffixes\n  dataframes &lt;- lapply(timepoints, function(tp) {\n    file_path &lt;- file.path(base_path, paste0(filename, patient_id, tp, \".TRB.tsv\"))\n    df &lt;- select_columns(file_path)\n    select_and_rename(df, tp)\n  })\n  \n  # Merge all dataframes\n  merged_df &lt;- Reduce(function(x, y) merge(x, y, by = \"clonotype_id\", all = TRUE), dataframes)\n  \n  # Replace NA values with 0\n  merged_df[is.na(merged_df)] &lt;- 0\n  merged_df &lt;- rename_columns(merged_df)\n  merged_df$Prevaccine_LOD &lt;- calculate_LOD(merged_df$Prevaccine_umi_fraction)\n  merged_df$Postvaccine_LOD &lt;- calculate_LOD(merged_df$Postvaccine_umi_fraction)\n  merged_df$Postnivo_LOD &lt;- calculate_LOD(merged_df$Postvaccine_umi_fraction)\n  \n  return(merged_df)\n}",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>PBMCs: Data Loading and Compilation</span>"
    ]
  },
  {
    "objectID": "Data_Processing.html#generating-dataframes-for-clone-visualization-analysis",
    "href": "Data_Processing.html#generating-dataframes-for-clone-visualization-analysis",
    "title": "1  PBMCs: Data Loading and Compilation",
    "section": "1.2 Generating dataframes for clone visualization / analysis",
    "text": "1.2 Generating dataframes for clone visualization / analysis\n\n# Inputting timepoints and mixcr output path to build list of clones dataframes. \n\n#Sequenced in three different batches\nfilename &lt;- \"Mac_TCR_PromethionRerun\"\nfilename_redo &lt;- \"Mac_Bulk_Redo\"\nfilename_extra &lt;- \"Mac_Francois_TCR\"\n\npromethion_base_path &lt;- \"/jsimonlab/users/bshim/mixcr_OUTPUT/Mac_TCR_PromethionRerun_downsampled/modified\"\nrerun_base_path &lt;- \"/jsimonlab/users/bshim/mixcr_OUTPUT/Mac_Bulk_Redo_downsampled/modified\"\nextra_sample_path &lt;- \"/jsimonlab/users/bshim/mixcr_OUTPUT/Mac_Francois_TCR_downsampled/modified\"\n\n\n# W24 was eliminated from PT106 timepoints due to lack of UMIs. \nPT106_timepoints &lt;- c(\"L2_W14\", \"PreL_W0\", \"W16\")\nPT106_merged_df &lt;- merge_patient_data(\"106\", promethion_base_path, PT106_timepoints, filename)\n\n# Example for PT108, longest patient on trial\nPT108_timepoints &lt;- c(\"L2_W14\", \"L3_W22\", \"LATE_W40\", \"PreL_W0\")\nPT108_merged_df &lt;- merge_patient_data(\"108\", promethion_base_path, PT108_timepoints,filename)\n\n# Example for PT111\nPT111_timepoints &lt;- c(\"L2_W14\", \"PreL_W0\")\nPT111_merged_df &lt;- merge_patient_data(\"111\", promethion_base_path, PT111_timepoints,filename)\n\nPT113_timepoints &lt;- c(\"w00\", \"w14\", \"w22\")\nPT113_merged_df &lt;- merge_patient_data_rerun(\"113\",rerun_base_path, PT113_timepoints, filename_redo)\n\nPT114_timepoints &lt;- c(\"L2_W14\", \"L3_W22\", \"PreL_W0\")\nPT114_merged_df &lt;- merge_patient_data(\"114\", promethion_base_path, PT114_timepoints,filename)\n\nPT117_timepoints &lt;- c(\"w00\", \"w14\", \"w22\")\nPT117_merged_df &lt;- merge_patient_data_rerun(\"117\", rerun_base_path, PT117_timepoints,filename_redo)\n\nPT116_timepoints &lt;- c(\"L2_W14\", \"L3_W22\", \"LATE_W40\", \"PreL_W0\")\nPT116_merged_df &lt;- merge_patient_data(\"116\", promethion_base_path, PT116_timepoints,filename)\n\nPT118_timepoints &lt;- c(\"L2_W14\", \"L3_W22\", \"PreL_W0\")\nPT118_merged_df &lt;- merge_patient_data(\"118\", promethion_base_path, PT118_timepoints,filename)\n\nPT119_timepoints &lt;- c(\"L2_W14\", \"L3_W22\", \"PreL_W0\")\nPT119_merged_df &lt;- merge_patient_data(\"119\", promethion_base_path, PT119_timepoints,filename)\n\nPT122_timepoints &lt;- c(\"L2\", \"L3\", \"Pre-LL\")\nPT122_merged_df &lt;- merge_patient_data_rerun(\"122\", extra_sample_path, PT122_timepoints,filename_extra)\n\nsaveRDS(PT106_merged_df, \"./PT106_merged_df.rds\")\nsaveRDS(PT108_merged_df, \"./PT108_merged_df.rds\")\nsaveRDS(PT111_merged_df, \"./PT111_merged_df.rds\")\nsaveRDS(PT113_merged_df, \"./PT113_merged_df.rds\")\nsaveRDS(PT114_merged_df, \"./PT114_merged_df.rds\")\nsaveRDS(PT116_merged_df, \"./PT116_merged_df.rds\")\nsaveRDS(PT117_merged_df, \"./PT117_merged_df.rds\")\nsaveRDS(PT118_merged_df, \"./PT118_merged_df.rds\")\nsaveRDS(PT119_merged_df, \"./PT119_merged_df.rds\")\nsaveRDS(PT122_merged_df, \"./PT122_merged_df.rds\")",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>PBMCs: Data Loading and Compilation</span>"
    ]
  },
  {
    "objectID": "Data_Processing.html#umi-filter-set-at-greater-than-5",
    "href": "Data_Processing.html#umi-filter-set-at-greater-than-5",
    "title": "1  PBMCs: Data Loading and Compilation",
    "section": "1.3 UMI filter set at greater than 5",
    "text": "1.3 UMI filter set at greater than 5\n\n#Filtering based on raw UMI counts and fold increase from the LOD\ncount_significant_clones_in_cluster_LOD_Filter &lt;- function(\n    results_df,\n    fold_change,\n    prevaccine_umi_threshold = 5,\n    postvaccine_umi_threshold = 5,\n    postnivo_umi_threshold = 5\n) {\n  # Get the lowest LOD value across all columns containing \"LOD\"\n  lod_cols &lt;- grep(\"LOD\", names(results_df), value = TRUE)\n  visualization_LOD &lt;- min(results_df[, lod_cols], na.rm = TRUE)\n  \n  # Replace 0 values in all *_umi_fraction columns with visualization_LOD\n  fraction_cols &lt;- grep(\"_umi_fraction$\", names(results_df), value = TRUE)\n  results_df[, fraction_cols] &lt;- lapply(results_df[, fraction_cols],\n                                        function(x) ifelse(x == 0, visualization_LOD, x))\n  \n  # Assign categories based on thresholds\n  has_Postnivo &lt;- \"Postnivo_umi_fraction\" %in% colnames(results_df)\n  has_w40 &lt;- \"w40_umi_fraction\" %in% colnames(results_df)\n  \n  if (has_Postnivo & has_w40) {\n    results_df &lt;- results_df %&gt;%\n      mutate(category = case_when(\n        (Postvaccine_umi_fraction &gt;= (Postvaccine_LOD) * fold_change) &\n          (Postvaccine_umi &gt; postvaccine_umi_threshold) ~ \"Passing_Vax_Threshold\",\n        (Postnivo_umi_fraction &gt;= (Postnivo_LOD) * fold_change) &\n          (Postnivo_umi &gt; postnivo_umi_threshold) ~ \"Passing_Nivo_Threshold\",\n        (Prevaccine_umi &gt; prevaccine_umi_threshold) &\n          (Prevaccine_umi_fraction &gt;= (Prevaccine_LOD) * fold_change) ~ \"Passing_Pre_Threshold\",\n        (w40_umi &gt; postnivo_umi_threshold) &\n          (w40_umi_fraction &gt;= (w40_LOD) * fold_change) ~ \"Passing_Nivo_Threshold\",\n        TRUE ~ \"Do_Not_Pass\"\n      ))\n    \n  } else if (has_Postnivo) {\n    results_df &lt;- results_df %&gt;%\n      mutate(category = case_when(\n        (Postvaccine_umi_fraction &gt;= (Postvaccine_LOD) * fold_change) &\n          (Postvaccine_umi &gt; postvaccine_umi_threshold) ~ \"Passing_Vax_Threshold\",  \n        (Postnivo_umi_fraction &gt;= (Postnivo_LOD) * fold_change) &\n          (Postnivo_umi &gt; postnivo_umi_threshold) ~ \"Passing_Nivo_Threshold\",\n        (Prevaccine_umi &gt; prevaccine_umi_threshold) &\n          (Prevaccine_umi_fraction &gt;= (Prevaccine_LOD) * fold_change) ~ \"Passing_Pre_Threshold\",\n        TRUE ~ \"Do_Not_Pass\"\n      ))\n    \n  } else if (\"w16_umi_fraction\" %in% colnames(results_df)) {\n    results_df &lt;- results_df %&gt;%\n      mutate(category = case_when(\n        (Postvaccine_umi_fraction &gt;= (Postvaccine_LOD) * fold_change) &\n          (Postvaccine_umi &gt; postvaccine_umi_threshold) ~ \"Passing_Vax_Threshold\",  \n        (Prevaccine_umi &gt; prevaccine_umi_threshold) &\n          (Prevaccine_umi_fraction &gt;= (Prevaccine_LOD) * fold_change) ~ \"Passing_Pre_Threshold\",\n        (w16_umi &gt; postvaccine_umi_threshold) &\n          (w16_umi_fraction &gt;= (w16_LOD) * fold_change) ~ \"Passing_Vax_Threshold\",\n        TRUE ~ \"Do_Not_Pass\"\n      ))\n    \n  } else {\n    results_df &lt;- results_df %&gt;%\n      mutate(category = case_when(\n        (Prevaccine_umi &gt; prevaccine_umi_threshold) &\n          (Prevaccine_umi_fraction &gt;= (Prevaccine_LOD) * fold_change) ~ \"Passing_Pre_Threshold\",\n        (Postvaccine_umi_fraction &gt;= (Postvaccine_LOD) * fold_change) &\n          (Postvaccine_umi &gt; postvaccine_umi_threshold) ~ \"Passing_Vax_Threshold\",  \n        TRUE ~ \"Do_Not_Pass\"\n      ))\n  }\n  \n  # 4. Store visualization LOD in the dataframe for later use in plotting\n  results_df$visualization_LOD &lt;- visualization_LOD\n  \n  return(results_df)\n}",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>PBMCs: Data Loading and Compilation</span>"
    ]
  },
  {
    "objectID": "Data_Processing.html#filtering-clones-from-the-visualization-dataframe.",
    "href": "Data_Processing.html#filtering-clones-from-the-visualization-dataframe.",
    "title": "1  PBMCs: Data Loading and Compilation",
    "section": "1.4 Filtering Clones from the Visualization Dataframe.",
    "text": "1.4 Filtering Clones from the Visualization Dataframe.\n\nfold_change &lt;- 5\nPT106_test &lt;- count_significant_clones_in_cluster_LOD_Filter(PT106_merged_df, fold_change)\n\nPT108_test &lt;- count_significant_clones_in_cluster_LOD_Filter(PT108_merged_df, fold_change)\n\nPT111_test &lt;- count_significant_clones_in_cluster_LOD_Filter(PT111_merged_df, fold_change)\n\nPT113_test &lt;- count_significant_clones_in_cluster_LOD_Filter(PT113_merged_df, fold_change)\n\nPT114_test &lt;- count_significant_clones_in_cluster_LOD_Filter(PT114_merged_df, fold_change)\n\nPT116_test &lt;- count_significant_clones_in_cluster_LOD_Filter(PT116_merged_df, fold_change)\n\nPT117_test &lt;- count_significant_clones_in_cluster_LOD_Filter(PT117_merged_df, fold_change)\n\nPT118_test &lt;- count_significant_clones_in_cluster_LOD_Filter(PT118_merged_df, fold_change)\n\nPT119_test &lt;- count_significant_clones_in_cluster_LOD_Filter(PT119_merged_df, fold_change)\n\nPT122_test &lt;- count_significant_clones_in_cluster_LOD_Filter(PT122_merged_df, fold_change)",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>PBMCs: Data Loading and Compilation</span>"
    ]
  },
  {
    "objectID": "Data_Processing.html#fishers-test-function",
    "href": "Data_Processing.html#fishers-test-function",
    "title": "1  PBMCs: Data Loading and Compilation",
    "section": "1.5 Fisher’s Test Function",
    "text": "1.5 Fisher’s Test Function\n\nfisher_test &lt;- function(merged_df) {\n  w00_vs_w14 &lt;- merged_df\n  results_w00_w14 &lt;- w00_vs_w14 %&gt;%\n    rowwise() %&gt;%\n    mutate(\n      fisher_p_value_post_vax = {\n        # Contingency table for pre-vaccine vs post-vaccine\n        clone_w14 &lt;- Postvaccine_umi\n        other_w14 &lt;- sum(merged_df$Postvaccine_umi) - clone_w14\n        clone_w0 &lt;- Prevaccine_umi\n        other_w0 &lt;- sum(merged_df$Prevaccine_umi) - clone_w0\n        \n        # Create a contingency table\n        contingency_table &lt;- matrix(c(clone_w0, other_w0, clone_w14, other_w14),\n                                    nrow = 2,\n                                    byrow = TRUE)\n        \n        # Perform Fisher's exact test\n        #boschloo(clone_w0, other_w0, clone_w14, other_w14,alternative=\"less\")\n        fisher.test(contingency_table, alternative = \"less\")$p.value\n      }\n    )\n  \n  if (\"Postnivo_umi\" %in% colnames(merged_df)) {\n    w14_vs_w22 &lt;- merged_df\n    results_w14_w22 &lt;- w14_vs_w22 %&gt;%\n      rowwise() %&gt;%\n      mutate(\n      fisher_p_value_post_nivo = {\n        # Check if either total_umi_W24 or total_umi_L3_W22 exists\n        clone_w24 &lt;- Postnivo_umi\n        other_w24 &lt;- sum(merged_df$Postnivo_umi) - clone_w24\n        clone_w14 &lt;- Postvaccine_umi\n        other_w14 &lt;- sum(merged_df$Postvaccine_umi) - clone_w14\n        \n        # Create a contingency table\n        contingency_table &lt;- matrix(c(clone_w14, other_w14, clone_w24, other_w24),\n                                    nrow = 2,\n                                    byrow = TRUE)\n        \n        # Perform Fisher's exact test\n        #boschloo(clone_w14, other_w14, clone_w24, other_w24,alternative=\"less\")\n        fisher.test(contingency_table, alternative = \"less\")$p.value\n      }\n    )\n  }\n  \n  if (\"Postnivo_umi\" %in% colnames(merged_df)) { \n    results_w00_w14$fisher_p_value_post_vax_adj &lt;- p.adjust(results_w00_w14$fisher_p_value_post_vax, method = 'BY')\n    results_w00_w14$fisher_p_value_post_vax_adj_BH &lt;- p.adjust(results_w00_w14$fisher_p_value_post_vax, method = 'BH')\n    results_w14_w22$fisher_p_value_post_nivo_adj &lt;- p.adjust(results_w14_w22$fisher_p_value_post_nivo, method = 'BY')\n    results_w14_w22$fisher_p_value_post_nivo_adj_BH &lt;- p.adjust(results_w14_w22$fisher_p_value_post_nivo, method = 'BH')\n    results_intermediate &lt;- merge(merged_df, results_w00_w14[c(\"clonotype_id\", \"fisher_p_value_post_vax\", \"fisher_p_value_post_vax_adj\", \"fisher_p_value_post_vax_adj_BH\")], by=\"clonotype_id\", all = T)\n    results &lt;- merge(results_intermediate, results_w14_w22[c(\"clonotype_id\", \"fisher_p_value_post_nivo\", \"fisher_p_value_post_nivo_adj\", \"fisher_p_value_post_nivo_adj_BH\")], by=\"clonotype_id\", all = T)\n  } else {\n    results_w00_w14$fisher_p_value_post_vax_adj &lt;- p.adjust(results_w00_w14$fisher_p_value_post_vax, method = 'BY')\n    results_w00_w14$fisher_p_value_post_vax_adj_BH &lt;- p.adjust(results_w00_w14$fisher_p_value_post_vax, method = 'BH')\n    results &lt;- merge(merged_df, results_w00_w14[c(\"clonotype_id\", \"fisher_p_value_post_vax\", \"fisher_p_value_post_vax_adj\", \"fisher_p_value_post_vax_adj_BH\")], by=\"clonotype_id\", all = T)\n  }\n  results[is.na(results)] &lt;- 1\n  return(results)\n}\n\nvaccine_def &lt;- c(\"post_W22(booster+Nivo)_expanded\", \"post_W14(vaccine)_expanded\", \"Pre-Existing\")\n\nlabel &lt;- function(df) {\n  has_w40 &lt;- \"w40_umi_fraction\" %in% colnames(df)\n  has_postnivo &lt;- \"Postnivo_umi_fraction\" %in% colnames(df)\n  if (has_w40) {\n    return_df &lt;- df %&gt;%\n    mutate(new_category = case_when(\n        (fisher_p_value_post_vax_adj_BH &lt; 0.05) & (Prevaccine_umi_fraction &lt;= visualization_LOD) & (Postnivo_umi_fraction &gt; Postnivo_LOD) & (w40_umi_fraction &gt; w40_LOD) ~ \"post_W14(vaccine)_expanded\",\n        (fisher_p_value_post_nivo_adj_BH &lt; 0.05) & (Prevaccine_umi_fraction &lt;= visualization_LOD) & (w40_umi_fraction &gt; w40_LOD) ~ \"post_W22(booster+Nivo)_expanded\",\n        TRUE ~ \"non_expanded\"\n      ))\n  } else if(has_postnivo) {\n      return_df &lt;- df %&gt;%\n    mutate(new_category = case_when(\n        (fisher_p_value_post_vax_adj_BH &lt; 0.05) & (Prevaccine_umi_fraction &lt;= visualization_LOD) & (Postnivo_umi_fraction &gt; Postnivo_LOD)  ~ \"post_W14(vaccine)_expanded\",\n      (fisher_p_value_post_nivo_adj_BH &lt; 0.05) & (Prevaccine_umi_fraction &lt;= visualization_LOD) ~ \"post_W22(booster+Nivo)_expanded\",\n        TRUE ~ \"non_expanded\"\n      ))\n  }\n  else {\n    return_df &lt;- df %&gt;%\n    mutate(new_category = case_when(\n        (fisher_p_value_post_vax_adj_BH &lt; 0.05) &\n          (Prevaccine_umi_fraction &lt;= visualization_LOD) ~ \"post_W14(vaccine)_expanded\",\n        TRUE ~ \"non_expanded\"\n      ))\n  }\n  \n  return(return_df)\n}",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>PBMCs: Data Loading and Compilation</span>"
    ]
  },
  {
    "objectID": "Data_Processing.html#applying-fishers-test-on-the-filtered-set-of-clones",
    "href": "Data_Processing.html#applying-fishers-test-on-the-filtered-set-of-clones",
    "title": "1  PBMCs: Data Loading and Compilation",
    "section": "1.6 Applying Fisher’s Test on the Filtered Set of Clones",
    "text": "1.6 Applying Fisher’s Test on the Filtered Set of Clones\n\n## Passing_Nivo_Threshold\n## Passing_Vax_Threshold \n## Passing_Pre_Threshold\nvaccine_def &lt;- c(\"Passing_Nivo_Threshold\", \"Passing_Vax_Threshold\", \"Passing_Pre_Threshold\")\n\n##printing the number of clones \n\nprint(paste(\"Prefilter:\", nrow(PT106_test)))\n\n[1] \"Prefilter: 113405\"\n\nPT106_test_fisher &lt;- PT106_test[PT106_test$category %in% vaccine_def,]\nprint(paste(\"Postfilter:\", nrow(PT106_test_fisher)))\n\n[1] \"Postfilter: 1657\"\n\nPT106_test_fisher &lt;- fisher_test(PT106_test_fisher)\nPT106_test_fisher_categorized &lt;- label(PT106_test_fisher)\nPT106_test_fisher_categorized$patient_id &lt;- rep(\"PT106\", nrow(PT106_test_fisher_categorized))\n\nprint(paste(\"Prefilter:\", nrow(PT108_test)))\n\n[1] \"Prefilter: 313088\"\n\nPT108_test_fisher &lt;- PT108_test[PT108_test$category %in% vaccine_def,]\nprint(paste(\"Postfilter:\", nrow(PT108_test_fisher)))\n\n[1] \"Postfilter: 4792\"\n\nPT108_test_fisher &lt;- fisher_test(PT108_test_fisher)\nPT108_test_fisher_categorized &lt;- label(PT108_test_fisher)\nPT108_test_fisher_categorized$patient_id &lt;- rep(\"PT108\", nrow(PT108_test_fisher_categorized))\n\nprint(paste(\"Prefilter:\", nrow(PT111_test)))\n\n[1] \"Prefilter: 108908\"\n\nPT111_test_fisher &lt;- PT111_test[PT111_test$category %in% vaccine_def,]\nprint(paste(\"Postfilter:\", nrow(PT111_test_fisher)))\n\n[1] \"Postfilter: 2505\"\n\nPT111_test_fisher &lt;- fisher_test(PT111_test_fisher)\nPT111_test_fisher_categorized &lt;- label(PT111_test_fisher)\nPT111_test_fisher_categorized$patient_id &lt;- rep(\"PT111\", nrow(PT111_test_fisher_categorized))\n\nprint(paste(\"Prefilter:\", nrow(PT113_test)))\n\n[1] \"Prefilter: 175797\"\n\nPT113_test_fisher &lt;- PT113_test[PT113_test$category %in% vaccine_def,]\nprint(paste(\"Postfilter:\", nrow(PT113_test_fisher)))\n\n[1] \"Postfilter: 6307\"\n\nPT113_test_fisher &lt;- fisher_test(PT113_test_fisher)\nPT113_test_fisher_categorized &lt;- label(PT113_test_fisher)\nPT113_test_fisher_categorized$patient_id &lt;- rep(\"PT113\", nrow(PT113_test_fisher_categorized))\n\nprint(paste(\"Prefilter:\", nrow(PT114_test)))\n\n[1] \"Prefilter: 230972\"\n\nPT114_test_fisher &lt;- PT114_test[PT114_test$category %in% vaccine_def,]\nprint(paste(\"Postfilter:\", nrow(PT114_test_fisher)))\n\n[1] \"Postfilter: 4486\"\n\nPT114_test_fisher &lt;- fisher_test(PT114_test_fisher)\nPT114_test_fisher_categorized &lt;- label(PT114_test_fisher)\nPT114_test_fisher_categorized$patient_id &lt;- rep(\"PT114\", nrow(PT114_test_fisher_categorized))\n\nprint(paste(\"Prefilter:\", nrow(PT116_test)))\n\n[1] \"Prefilter: 151826\"\n\nPT116_test_fisher &lt;- PT116_test[PT116_test$category %in% vaccine_def,]\nprint(paste(\"Postfilter:\", nrow(PT116_test_fisher)))\n\n[1] \"Postfilter: 3797\"\n\nPT116_test_fisher &lt;- fisher_test(PT116_test_fisher)\nPT116_test_fisher_categorized &lt;- label(PT116_test_fisher)\nPT116_test_fisher_categorized$patient_id &lt;- rep(\"PT116\", nrow(PT116_test_fisher_categorized))\n\nprint(paste(\"Prefilter:\", nrow(PT117_test)))\n\n[1] \"Prefilter: 162454\"\n\nPT117_test_fisher &lt;- PT117_test[PT117_test$category %in% vaccine_def,]\nprint(paste(\"Postfilter:\", nrow(PT117_test_fisher)))\n\n[1] \"Postfilter: 3845\"\n\nPT117_test_fisher &lt;- fisher_test(PT117_test_fisher)\nPT117_test_fisher_categorized &lt;- label(PT117_test_fisher)\nPT117_test_fisher_categorized$patient_id &lt;- rep(\"PT117\", nrow(PT117_test_fisher_categorized))\n\nprint(paste(\"Prefilter:\", nrow(PT118_test)))\n\n[1] \"Prefilter: 165135\"\n\nPT118_test_fisher &lt;- PT118_test[PT118_test$category %in% vaccine_def,]\nprint(paste(\"Postfilter:\", nrow(PT118_test_fisher)))\n\n[1] \"Postfilter: 5407\"\n\nPT118_test_fisher &lt;- fisher_test(PT118_test_fisher)\nPT118_test_fisher_categorized &lt;- label(PT118_test_fisher)\nPT118_test_fisher_categorized$patient_id &lt;- rep(\"PT118\", nrow(PT118_test_fisher_categorized))\n\nprint(paste(\"Prefilter:\", nrow(PT119_test)))\n\n[1] \"Prefilter: 151616\"\n\nPT119_test_fisher &lt;- PT119_test[PT119_test$category %in% vaccine_def,]\nprint(paste(\"Postfilter:\", nrow(PT119_test_fisher)))\n\n[1] \"Postfilter: 2462\"\n\nPT119_test_fisher &lt;- fisher_test(PT119_test_fisher)\nPT119_test_fisher_categorized &lt;- label(PT119_test_fisher)\nPT119_test_fisher_categorized$patient_id &lt;- rep(\"PT119\", nrow(PT119_test_fisher_categorized))\n\nprint(paste(\"Prefilter:\", nrow(PT122_test)))\n\n[1] \"Prefilter: 131955\"\n\nPT122_test_fisher &lt;- PT122_test[PT122_test$category %in% vaccine_def,]\nprint(paste(\"Postfilter:\", nrow(PT122_test_fisher)))\n\n[1] \"Postfilter: 2376\"\n\nPT122_test_fisher &lt;- fisher_test(PT122_test_fisher)\nPT122_test_fisher_categorized &lt;- label(PT122_test_fisher)\nPT122_test_fisher_categorized$patient_id &lt;- rep(\"PT122\", nrow(PT122_test_fisher_categorized))",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>PBMCs: Data Loading and Compilation</span>"
    ]
  },
  {
    "objectID": "Data_Processing.html#assign-response-groups",
    "href": "Data_Processing.html#assign-response-groups",
    "title": "1  PBMCs: Data Loading and Compilation",
    "section": "1.7 Assign Response Groups",
    "text": "1.7 Assign Response Groups\n\n# Define patient groups\nprogressive &lt;- c(\"PT111\", \"PT114\", \"PT117\", \"PT113\")\ntransient_response &lt;- c(\"PT106\", \"PT108\", \"PT116\")\nstable_disease &lt;- c(\"PT118\", \"PT119\", \"PT122\")\n\n# Function to assign response_group based on patient_id\nassign_response_group &lt;- function(df) {\n  df &lt;- df %&gt;%\n    mutate(across(contains(\"umi_fraction\"), ~ . * 100),\n           across(contains(\"LOD\"), ~ . * 100))\n  df %&gt;%\n    mutate(response = case_when(\n      patient_id %in% progressive ~ \"Progressive\",\n      patient_id %in% transient_response ~ \"Transient_Response\",\n      patient_id %in% stable_disease ~ \"Stable_Disease\",\n      TRUE ~ NA_character_\n    ))\n}\n\n# Apply to each dataframe\nPT106_test_fisher_categorized &lt;- assign_response_group(PT106_test_fisher_categorized)\nPT108_test_fisher_categorized &lt;- assign_response_group(PT108_test_fisher_categorized)\nPT111_test_fisher_categorized &lt;- assign_response_group(PT111_test_fisher_categorized)\nPT113_test_fisher_categorized &lt;- assign_response_group(PT113_test_fisher_categorized)\nPT114_test_fisher_categorized &lt;- assign_response_group(PT114_test_fisher_categorized)\nPT116_test_fisher_categorized &lt;- assign_response_group(PT116_test_fisher_categorized)\nPT117_test_fisher_categorized &lt;- assign_response_group(PT117_test_fisher_categorized)\nPT118_test_fisher_categorized &lt;- assign_response_group(PT118_test_fisher_categorized)\nPT119_test_fisher_categorized &lt;- assign_response_group(PT119_test_fisher_categorized)\nPT122_test_fisher_categorized &lt;- assign_response_group(PT122_test_fisher_categorized)",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>PBMCs: Data Loading and Compilation</span>"
    ]
  },
  {
    "objectID": "Data_Processing.html#number-of-postvax-and-postnivo-clones",
    "href": "Data_Processing.html#number-of-postvax-and-postnivo-clones",
    "title": "1  PBMCs: Data Loading and Compilation",
    "section": "1.8 Number of Postvax and Postnivo Clones",
    "text": "1.8 Number of Postvax and Postnivo Clones\n\ntable(PT106_test_fisher_categorized$new_category)\n\n\n              non_expanded post_W14(vaccine)_expanded \n                      1557                        100 \n\ntable(PT108_test_fisher_categorized$new_category)\n\n\n                   non_expanded      post_W14(vaccine)_expanded \n                           4716                              38 \npost_W22(booster+Nivo)_expanded \n                             38 \n\ntable(PT111_test_fisher_categorized$new_category)\n\n\n              non_expanded post_W14(vaccine)_expanded \n                      2446                         59 \n\ntable(PT113_test_fisher_categorized$new_category)\n\n\n                   non_expanded      post_W14(vaccine)_expanded \n                           5728                              61 \npost_W22(booster+Nivo)_expanded \n                            518 \n\ntable(PT114_test_fisher_categorized$new_category)\n\n\n                   non_expanded      post_W14(vaccine)_expanded \n                           3694                             142 \npost_W22(booster+Nivo)_expanded \n                            650 \n\ntable(PT116_test_fisher_categorized$new_category)\n\n\n                   non_expanded      post_W14(vaccine)_expanded \n                           3678                              90 \npost_W22(booster+Nivo)_expanded \n                             29 \n\ntable(PT117_test_fisher_categorized$new_category)\n\n\n                   non_expanded      post_W14(vaccine)_expanded \n                           3549                               7 \npost_W22(booster+Nivo)_expanded \n                            289 \n\ntable(PT118_test_fisher_categorized$new_category)\n\n\n                   non_expanded      post_W14(vaccine)_expanded \n                           5228                             150 \npost_W22(booster+Nivo)_expanded \n                             29 \n\ntable(PT119_test_fisher_categorized$new_category)\n\n\n                   non_expanded      post_W14(vaccine)_expanded \n                           2232                              75 \npost_W22(booster+Nivo)_expanded \n                            155 \n\ntable(PT122_test_fisher_categorized$new_category)\n\n\n                   non_expanded      post_W14(vaccine)_expanded \n                           2234                             124 \npost_W22(booster+Nivo)_expanded \n                             18 \n\npatient_list &lt;- list(\n  PT106_test_fisher_categorized,\n  PT108_test_fisher_categorized,\n  PT111_test_fisher_categorized,\n  PT113_test_fisher_categorized,\n  PT114_test_fisher_categorized,\n  PT116_test_fisher_categorized,\n  PT117_test_fisher_categorized,\n  PT118_test_fisher_categorized,\n  PT119_test_fisher_categorized,\n  PT122_test_fisher_categorized\n)\ncategory_counts &lt;- lapply(patient_list, function(df) table(df$new_category))\n\nget_count &lt;- function(count_table, category) {\n  if (category %in% names(count_table)) {\n    return(count_table[[category]])\n  } else {\n    return(NA)   # if category not present, treat count as 0\n  }\n}\n\npostW14_counts &lt;- sapply(category_counts, get_count, \n                         category = \"post_W14(vaccine)_expanded\")\n\npostW22_counts &lt;- sapply(category_counts, get_count, \n                         category = \"post_W22(booster+Nivo)_expanded\")\n\ncat(\"Median post_W14(vaccine)_expanded =\", median(postW14_counts, na.rm = TRUE), \"\\n\")\n\nMedian post_W14(vaccine)_expanded = 82.5 \n\ncat(\"Median post_W22(booster+Nivo)_expanded =\", median(postW22_counts, na.rm=TRUE), \"\\n\")\n\nMedian post_W22(booster+Nivo)_expanded = 96.5 \n\n\n\nsaveRDS(PT106_test_fisher_categorized, \"./PT106_test_fisher_categorized.rds\")\nsaveRDS(PT108_test_fisher_categorized, \"./PT108_test_fisher_categorized.rds\")\nsaveRDS(PT111_test_fisher_categorized, \"./PT111_test_fisher_categorized.rds\")\nsaveRDS(PT113_test_fisher_categorized, \"./PT113_test_fisher_categorized.rds\")\nsaveRDS(PT114_test_fisher_categorized, \"./PT114_test_fisher_categorized.rds\")\nsaveRDS(PT116_test_fisher_categorized, \"./PT116_test_fisher_categorized.rds\")\nsaveRDS(PT117_test_fisher_categorized, \"./PT117_test_fisher_categorized.rds\")\nsaveRDS(PT118_test_fisher_categorized, \"./PT118_test_fisher_categorized.rds\")\nsaveRDS(PT119_test_fisher_categorized, \"./PT119_test_fisher_categorized.rds\")\nsaveRDS(PT122_test_fisher_categorized, \"./PT122_test_fisher_categorized.rds\")\n\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] lubridate_1.9.4 forcats_1.0.0   stringr_1.5.1   dplyr_1.1.4    \n [5] purrr_1.0.2     readr_2.1.5     tidyr_1.3.1     tibble_3.2.1   \n [9] ggplot2_3.5.1   tidyverse_2.0.0\n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.5       jsonlite_2.0.0     compiler_4.3.2     tidyselect_1.2.1  \n [5] dichromat_2.0-0.1  scales_1.4.0       fastmap_1.2.0      R6_2.6.1          \n [9] generics_0.1.3     knitr_1.50         htmlwidgets_1.6.4  pillar_1.10.1     \n[13] RColorBrewer_1.1-3 tzdb_0.5.0         rlang_1.1.5        stringi_1.8.7     \n[17] xfun_0.52          timechange_0.3.0   cli_3.6.4          withr_3.0.2       \n[21] magrittr_2.0.3     digest_0.6.37      grid_4.3.2         rstudioapi_0.17.1 \n[25] hms_1.1.3          lifecycle_1.0.4    vctrs_0.6.5        evaluate_1.0.3    \n[29] glue_1.8.0         farver_2.1.2       rmarkdown_2.29     tools_4.3.2       \n[33] pkgconfig_2.0.3    htmltools_0.5.8.1",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>PBMCs: Data Loading and Compilation</span>"
    ]
  },
  {
    "objectID": "Kmeans_Clustering.html",
    "href": "Kmeans_Clustering.html",
    "title": "2  PBMCs: Kmeans Clustering Analysis",
    "section": "",
    "text": "2.1 Package Loading Set Up\n.libPaths(c(\"/homes8/bohoon/R/x86_64-pc-linux-gnu-library/4.1\", \"/homes8/bohoon/R/x86_64-pc-linux-gnu-library/4.2\", \"/homes8/bohoon/R/x86_64-pc-linux-gnu-library/4.3\", \"/homes8/bohoon/R/x86_64-pc-linux-gnu-library/not_4.3\", \"/homes8/bohoon/R/x86_64-pc-linux-gnu-library/4.4\"))\nlibrary(dplyr)\n\nWarning: package 'dplyr' was built under R version 4.4.0\n\n\n\nAttaching package: 'dplyr'\n\n\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n\n\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n\nlibrary(purrr)\nlibrary(tidyverse)\n\nWarning: package 'ggplot2' was built under R version 4.4.0\n\n\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ readr     2.1.5     \n\n\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>PBMCs: Kmeans Clustering Analysis</span>"
    ]
  },
  {
    "objectID": "Kmeans_Clustering.html#loading-in-unfiltered-dataframe",
    "href": "Kmeans_Clustering.html#loading-in-unfiltered-dataframe",
    "title": "2  PBMCs: Kmeans Clustering Analysis",
    "section": "2.2 Loading in Unfiltered Dataframe",
    "text": "2.2 Loading in Unfiltered Dataframe\n\nPT106_merged_df &lt;- readRDS(\"./PT106_merged_df.rds\")\nPT108_merged_df &lt;- readRDS(\"./PT108_merged_df.rds\")\nPT111_merged_df &lt;- readRDS(\"./PT111_merged_df.rds\")\nPT113_merged_df &lt;- readRDS(\"./PT113_merged_df.rds\")\nPT114_merged_df &lt;- readRDS( \"./PT114_merged_df.rds\")\nPT116_merged_df &lt;- readRDS(\"./PT116_merged_df.rds\")\nPT117_merged_df &lt;- readRDS(\"./PT117_merged_df.rds\")\nPT118_merged_df &lt;- readRDS(\"./PT118_merged_df.rds\")\nPT119_merged_df &lt;- readRDS(\"./PT119_merged_df.rds\")\nPT122_merged_df &lt;- readRDS(\"./PT122_merged_df.rds\")\n\n\npatient_dfs_postnivo &lt;- list(\n  PT108 = PT108_merged_df,\n  PT113 = PT113_merged_df,\n  PT114 = PT114_merged_df, \n  PT116 = PT116_merged_df,\n  PT117 = PT117_merged_df, \n  PT118 = PT118_merged_df, \n  PT119 = PT119_merged_df,\n  PT122 = PT122_merged_df\n)\n\n\n\n# Find common columns across all dataframes (trying to merge across dataframes)\ncommon_cols_postnivo &lt;- Reduce(intersect, lapply(patient_dfs_postnivo, colnames))\n# Subset all dataframes to only those columns\npatient_dfs_postnivo &lt;- lapply(patient_dfs_postnivo, function(df) df[,common_cols_postnivo])\n\n# Combine all dataframes into one list, adding patient ID\ncombined_df_postnivo &lt;- bind_rows(\n  lapply(names(patient_dfs_postnivo), function(pid) {\n    df &lt;- patient_dfs_postnivo[[pid]]\n    df$patient_id &lt;- pid\n    return(df)\n  })\n)\n\ndf_matrix_postnivo &lt;- combined_df_postnivo %&gt;%\n  mutate(clone_label = paste(clonotype_id, patient_id, sep = \"_\")) %&gt;%\n  dplyr::select(clone_label, Prevaccine_umi_fraction, Postvaccine_umi_fraction, Postnivo_umi_fraction)\n\numi_matrix_postnivo &lt;- as.matrix(df_matrix_postnivo[, -1])\nrownames(umi_matrix_postnivo) &lt;- df_matrix_postnivo$clone_label",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>PBMCs: Kmeans Clustering Analysis</span>"
    ]
  },
  {
    "objectID": "Kmeans_Clustering.html#running-kmeans-analysis",
    "href": "Kmeans_Clustering.html#running-kmeans-analysis",
    "title": "2  PBMCs: Kmeans Clustering Analysis",
    "section": "2.3 Running Kmeans Analysis",
    "text": "2.3 Running Kmeans Analysis\n\n## Running Kmeans Analysis \nset.seed(6)\n\nsds_nivo &lt;- apply(umi_matrix_postnivo, 1, sd)\nfiltered_postnivo &lt;- umi_matrix_postnivo[sds_nivo &gt; 0,]\n\nscaled_umi_matrix_postnivo &lt;- t(scale(t(filtered_postnivo)))\nkm_postnivo &lt;- kmeans(scaled_umi_matrix_postnivo, centers = 5, iter.max = 50)\nkm_postnivo$centers\n\n  Prevaccine_umi_fraction Postvaccine_umi_fraction Postnivo_umi_fraction\n1              -1.0937522               0.79305016             0.3007020\n2              -1.0265353               0.08903749             0.9374978\n3              -0.5603236               1.14732493            -0.5870013\n4              -0.5575350              -0.58951352             1.1470486\n5               1.1330068              -0.56216007            -0.5708468",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>PBMCs: Kmeans Clustering Analysis</span>"
    ]
  },
  {
    "objectID": "Kmeans_Clustering.html#plotting-variances-based-on-number-of-ks",
    "href": "Kmeans_Clustering.html#plotting-variances-based-on-number-of-ks",
    "title": "2  PBMCs: Kmeans Clustering Analysis",
    "section": "2.4 Plotting variances based on number of Ks",
    "text": "2.4 Plotting variances based on number of Ks\n\n# Analogous to Elbow Method for finding the optimal number of clusters\nset.seed(4)\n# plot k = 2 to k = 15.\nk.max &lt;- 15\ndata &lt;- umi_matrix_postnivo\nwss &lt;- sapply(1:k.max, \n              function(k){kmeans(data, k, iter.max = 50)$tot.withinss})\nplot(1:k.max, wss,\n     type=\"b\", pch = 19, frame = FALSE, \n     xlab=\"Number of clusters K\",\n     ylab=\"Total within-clusters sum of squares\")",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>PBMCs: Kmeans Clustering Analysis</span>"
    ]
  },
  {
    "objectID": "Kmeans_Clustering.html#plotting-the-centroids-and-the-sd-from-the-centroids",
    "href": "Kmeans_Clustering.html#plotting-the-centroids-and-the-sd-from-the-centroids",
    "title": "2  PBMCs: Kmeans Clustering Analysis",
    "section": "2.5 Plotting the centroids and the SD from the centroids",
    "text": "2.5 Plotting the centroids and the SD from the centroids\n\n# Get cluster assignment for each row\ncluster_assignments &lt;- km_postnivo$cluster\nscaled_mat &lt;- as.data.frame(scaled_umi_matrix_postnivo)\nscaled_mat$cluster &lt;- factor(cluster_assignments)\nscaled_mat$id &lt;- rownames(scaled_mat)\n\n# Reshape to long format\nlong_scaled &lt;- scaled_mat %&gt;%\n  pivot_longer(cols = c(Prevaccine_umi_fraction, Postvaccine_umi_fraction, Postnivo_umi_fraction),\n               names_to = \"timepoint\", values_to = \"value\")\n\ncentroid_long &lt;- km_postnivo$centers %&gt;%\n  as.data.frame() %&gt;%\n  mutate(cluster = factor(rownames(.))) %&gt;%\n  pivot_longer(\n    cols = -cluster,  # pivot all columns except 'cluster'\n    names_to = \"timepoint\",\n    values_to = \"centroid_value\"\n  )\n\n# Join data to get centroid per cluster + timepoint\njoined &lt;- long_scaled %&gt;%\n  left_join(centroid_long, by = c(\"cluster\", \"timepoint\")) %&gt;%\n  mutate(sq_diff = (value - centroid_value)^2)\n\n# Calculate SD around the centroid (not the mean)\nsummary_stats &lt;- joined %&gt;%\n  group_by(cluster, timepoint, centroid_value) %&gt;%\n  summarise(\n    sd = sqrt(mean(sq_diff)),\n    lower = centroid_value - sd,\n    upper = centroid_value + sd,\n    .groups = \"drop\"\n  )\n\nWarning: Returning more (or less) than 1 row per `summarise()` group was deprecated in\ndplyr 1.1.0.\nℹ Please use `reframe()` instead.\nℹ When switching from `summarise()` to `reframe()`, remember that `reframe()`\n  always returns an ungrouped data frame and adjust accordingly.\n\nsummary_stats &lt;- summary_stats %&gt;%\n    distinct(cluster, timepoint, .keep_all = TRUE)",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>PBMCs: Kmeans Clustering Analysis</span>"
    ]
  },
  {
    "objectID": "Kmeans_Clustering.html#plotting-means-of-each-cluster-with-error-bar",
    "href": "Kmeans_Clustering.html#plotting-means-of-each-cluster-with-error-bar",
    "title": "2  PBMCs: Kmeans Clustering Analysis",
    "section": "2.6 Plotting means of each cluster with error bar",
    "text": "2.6 Plotting means of each cluster with error bar\n\nsummary_stats$timepoint &lt;- factor(summary_stats$timepoint, levels=c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\"))\nggplot(summary_stats, aes(x = timepoint, y = centroid_value, group = cluster, color = cluster, fill = cluster)) +\n  geom_line(size = 1) +\n  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2, linetype = 0) +\n  theme_minimal(base_size = 14) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  labs(y = \"Scaled frequency\", x = \"Timepoint\", title = \"Cluster Centroids with SD\")\n\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nℹ Please use `linewidth` instead.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>PBMCs: Kmeans Clustering Analysis</span>"
    ]
  },
  {
    "objectID": "Kmeans_Clustering.html#calculating-scaled-frequency-means-of-each-cluster-divided-by-response-groups",
    "href": "Kmeans_Clustering.html#calculating-scaled-frequency-means-of-each-cluster-divided-by-response-groups",
    "title": "2  PBMCs: Kmeans Clustering Analysis",
    "section": "2.7 Calculating scaled frequency means of each cluster divided by response groups",
    "text": "2.7 Calculating scaled frequency means of each cluster divided by response groups\n\n#faceting this by patient / response group\ncluster_assignments &lt;- km_postnivo$cluster\n\n#can generate dataframe with both the scaled and the raw frequencies. \n\nscaled_mat &lt;- as.data.frame(scaled_umi_matrix_postnivo)\nscaled_mat$cluster &lt;- factor(cluster_assignments)\nscaled_mat$id &lt;- rownames(scaled_mat)\nscaled_mat$patient &lt;- str_extract(scaled_mat$id, \"PT\\\\d+\")\n\n\n# Example patient groups\nprogressive &lt;- c(\"PT111\", \"PT114\", \"PT117\", \"PT113\")\ntransient_response &lt;- c(\"PT106\", \"PT108\", \"PT116\")\nstable_disease &lt;- c(\"PT118\", \"PT119\", \"PT122\")\n\n# Add response column\nscaled_mat &lt;- scaled_mat %&gt;%\n  mutate(response = case_when(\n    patient %in% progressive ~ \"Progressive\",\n    patient %in% transient_response ~ \"Transient_Response\",\n    patient %in% stable_disease ~ \"Stable_Disease\",\n    TRUE ~ NA_character_  # For patients not in any group\n  ))\n\n\n# Reshape\nlong_scaled &lt;- scaled_mat %&gt;%\n  pivot_longer(cols = c(Prevaccine_umi_fraction, Postvaccine_umi_fraction, Postnivo_umi_fraction),\n               names_to = \"timepoint\", values_to = \"value\")\n\n# generating summary stats\nsummary_stats &lt;- long_scaled %&gt;%\n  group_by(cluster,timepoint, response) %&gt;%\n  summarise(\n    mean_val = mean(value, na.rm = TRUE),\n    sd = sd(value, na.rm = TRUE),\n    count = n(),\n    lower = mean_val - sd,\n    upper = mean_val + sd,\n    .groups = \"drop\"\n  )\n\n\nsummary_stats &lt;- summary_stats %&gt;%\n    distinct(cluster,timepoint,response, .keep_all = TRUE)",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>PBMCs: Kmeans Clustering Analysis</span>"
    ]
  },
  {
    "objectID": "Kmeans_Clustering.html#plotting-the-mean-frequency-within-each-cluster-with-its-se",
    "href": "Kmeans_Clustering.html#plotting-the-mean-frequency-within-each-cluster-with-its-se",
    "title": "2  PBMCs: Kmeans Clustering Analysis",
    "section": "2.8 Plotting the mean frequency within each cluster with its SE",
    "text": "2.8 Plotting the mean frequency within each cluster with its SE\n\nsummary_stats$timepoint &lt;- factor(summary_stats$timepoint, levels=c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\"))\n\nlabel_data &lt;- summary_stats[summary_stats$timepoint == \"Postnivo_umi_fraction\", ]\n\nggplot(summary_stats, aes(x = timepoint, y = mean_val, group = cluster, color = cluster)) +\n  geom_line(size = 1) +\n  geom_ribbon(aes(ymin = lower, ymax = upper, fill = cluster), alpha = 0.2, linetype = 0) +\n  ggrepel::geom_text_repel(\n    data = label_data, aes(label = paste0(\"n=\", count), color = cluster),, \n    size = 3, show.legend = FALSE, \n    direction = \"y\", box.padding = 0.0005,\n    label.padding = 0.0005, nudge_x = 0.2\n  ) +\n  scale_color_manual(\n    values = c(\n      \"1\" = \"#E41A1C\",  # red\n      \"2\" = \"#B3B300\",  # olive/yellow\n      \"3\" = \"#00B2B2\",  # teal\n      \"4\" = \"#4DA6FF\",  # light blue\n      \"5\" = \"#FF99FF\"   # pink\n    )\n  ) +\n  scale_fill_manual(\n    values = c(\n      \"1\" = \"#E41A1C\",\n      \"2\" = \"#B3B300\",\n      \"3\" = \"#00B2B2\",\n      \"4\" = \"#4DA6FF\",\n      \"5\" = \"#FF99FF\"\n    )\n  ) +\n  theme_classic(base_size = 14) +\n  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +\n  labs(\n    y = \"Raw Frequency\", \n    x = \"Timepoint\", \n    title = \"Cluster Mean for Denovo Clones Separated by Response\"\n  ) + facet_wrap(~response)\n\nWarning in ggrepel::geom_text_repel(data = label_data, aes(label = paste0(\"n=\",\n: Ignoring unknown parameters: `label.padding`\n\n\n\n\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] lubridate_1.9.4 forcats_1.0.0   stringr_1.5.1   readr_2.1.5    \n [5] tidyr_1.3.1     tibble_3.2.1    ggplot2_3.5.1   tidyverse_2.0.0\n [9] purrr_1.0.2     dplyr_1.1.4    \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.5       jsonlite_2.0.0     compiler_4.3.2     Rcpp_1.1.0        \n [5] tidyselect_1.2.1   dichromat_2.0-0.1  scales_1.4.0       fastmap_1.2.0     \n [9] R6_2.6.1           labeling_0.4.3     generics_0.1.3     knitr_1.50        \n[13] htmlwidgets_1.6.4  ggrepel_0.9.6      pillar_1.10.1      RColorBrewer_1.1-3\n[17] tzdb_0.5.0         rlang_1.1.5        stringi_1.8.7      xfun_0.52         \n[21] timechange_0.3.0   cli_3.6.4          withr_3.0.2        magrittr_2.0.3    \n[25] digest_0.6.37      grid_4.3.2         rstudioapi_0.17.1  hms_1.1.3         \n[29] lifecycle_1.0.4    vctrs_0.6.5        evaluate_1.0.3     glue_1.8.0        \n[33] farver_2.1.2       rmarkdown_2.29     tools_4.3.2        pkgconfig_2.0.3   \n[37] htmltools_0.5.8.1",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>PBMCs: Kmeans Clustering Analysis</span>"
    ]
  },
  {
    "objectID": "Visualization.html",
    "href": "Visualization.html",
    "title": "3  PBMCs: Data Visualization",
    "section": "",
    "text": "3.1 Package Set Up\nlibrary(dplyr)\n\n\nAttaching package: 'dplyr'\n\n\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n\n\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n\nlibrary(tidyverse)\n\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ forcats   1.0.0     ✔ readr     2.1.5\n✔ ggplot2   3.5.1     ✔ stringr   1.5.1\n✔ lubridate 1.9.4     ✔ tibble    3.2.1\n✔ purrr     1.0.4     ✔ tidyr     1.3.1\n\n\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors\n\nlibrary(colorRamp2)\n\nWarning: package 'colorRamp2' was built under R version 4.4.0\n\nlibrary(ComplexHeatmap)\n\nLoading required package: grid\n========================================\nComplexHeatmap version 2.18.0\nBioconductor page: http://bioconductor.org/packages/ComplexHeatmap/\nGithub page: https://github.com/jokergoo/ComplexHeatmap\nDocumentation: http://jokergoo.github.io/ComplexHeatmap-reference\n\nIf you use it in published research, please cite either one:\n- Gu, Z. Complex Heatmap Visualization. iMeta 2022.\n- Gu, Z. Complex heatmaps reveal patterns and correlations in multidimensional \n    genomic data. Bioinformatics 2016.\n\n\nThe new InteractiveComplexHeatmap package can directly export static \ncomplex heatmaps into an interactive Shiny app with zero effort. Have a try!\n\nThis message can be suppressed by:\n  suppressPackageStartupMessages(library(ComplexHeatmap))\n========================================\n\nlibrary(cowplot)\n\n\nAttaching package: 'cowplot'\n\nThe following object is masked from 'package:lubridate':\n\n    stamp\n\nlibrary(ggplot2)\nlibrary(ggridges)\nlibrary(vegan)\n\nLoading required package: permute\nLoading required package: lattice\n\nlibrary(scales)\n\n\nAttaching package: 'scales'\n\nThe following object is masked from 'package:purrr':\n\n    discard\n\nThe following object is masked from 'package:readr':\n\n    col_factor\n\nlibrary(colorspace)",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#loading-in-dataframes",
    "href": "Visualization.html#loading-in-dataframes",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.2 Loading in dataframes",
    "text": "3.2 Loading in dataframes\n\nPT106_test_fisher_categorized &lt;- readRDS(\"./PT106_test_fisher_categorized.rds\")\nPT108_test_fisher_categorized &lt;- readRDS(\"./PT108_test_fisher_categorized.rds\")\nPT111_test_fisher_categorized &lt;- readRDS(\"./PT111_test_fisher_categorized.rds\")\nPT113_test_fisher_categorized &lt;- readRDS(\"./PT113_test_fisher_categorized.rds\")\nPT114_test_fisher_categorized &lt;- readRDS( \"./PT114_test_fisher_categorized.rds\")\nPT116_test_fisher_categorized &lt;- readRDS(\"./PT116_test_fisher_categorized.rds\")\nPT117_test_fisher_categorized &lt;- readRDS(\"./PT117_test_fisher_categorized.rds\")\nPT118_test_fisher_categorized &lt;- readRDS(\"./PT118_test_fisher_categorized.rds\")\nPT119_test_fisher_categorized &lt;- readRDS(\"./PT119_test_fisher_categorized.rds\")\nPT122_test_fisher_categorized &lt;- readRDS(\"./PT122_test_fisher_categorized.rds\")",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#combine-dataframe-for-visualization",
    "href": "Visualization.html#combine-dataframe-for-visualization",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.3 Combine Dataframe for Visualization",
    "text": "3.3 Combine Dataframe for Visualization\n\nfisher_clusters &lt;- bind_rows(\n  PT122_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT122\"),\n  PT119_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT119\"),\n  PT118_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT118\"),\n  PT117_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT117\"),\n  PT116_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT116\"),\n  PT114_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT114\"),\n  PT113_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT113\"),\n  PT111_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT111\"),\n  PT108_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT108\"),\n  PT106_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT106\")\n)\n\nex &lt;- fisher_clusters %&gt;% \n  group_by(patient_id, new_category) %&gt;%\n  summarize(count=n(), .groups = \"drop\")",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#plotting-proportion-of-postvax-expanded-and-postnivo-expanded",
    "href": "Visualization.html#plotting-proportion-of-postvax-expanded-and-postnivo-expanded",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.4 Plotting Proportion of Postvax Expanded and Postnivo Expanded",
    "text": "3.4 Plotting Proportion of Postvax Expanded and Postnivo Expanded\n\nlibrary(dplyr)\nlibrary(ggplot2)\n\n# Define the relevant categories\nsig_categories &lt;- c(\"post_W14(vaccine)_expanded\", \"post_W22(booster+Nivo)_expanded\")\n\n# Filter only significant clones\nsig_clones &lt;- fisher_clusters %&gt;%\n  filter(new_category %in% sig_categories)\n\n# Create a new column to label as postvax or postnivo\nsig_clones &lt;- sig_clones %&gt;%\n  mutate(expansion_type = case_when(\n    new_category == \"post_W14(vaccine)_expanded\" ~ \"Postvax\",\n    new_category == \"post_W22(booster+Nivo)_expanded\" ~ \"Postnivo\"\n  ))\n\n# Count and calculate proportions per patient\nsig_summary &lt;- sig_clones %&gt;%\n  group_by(patient_id, expansion_type) %&gt;%\n  summarise(count = n(), .groups = \"drop\") %&gt;%\n  group_by(patient_id) %&gt;%\n  mutate(proportion = count / sum(count))\n\n# Set factor levels for patient order\nsig_summary$patient_id &lt;- factor(\n  sig_summary$patient_id,\n  levels = c(\"PT106\",\"PT108\", \"PT116\", \"PT118\", \"PT119\", \"PT122\", \"PT111\", \"PT113\", \"PT114\", \"PT117\")\n)\n\n# patient groupings\nprogressive &lt;- c(\"PT111\", \"PT114\", \"PT117\", \"PT113\")\ntransient_response &lt;- c(\"PT106\", \"PT108\", \"PT116\")\nstable_disease &lt;- c(\"PT118\", \"PT119\", \"PT122\")\n\n# Add response column\nsig_summary &lt;- sig_summary %&gt;%\n  mutate(response = case_when(\n    patient_id %in% progressive ~ \"Progressive\",\n    patient_id %in% transient_response ~ \"Transient_Response\",\n    patient_id %in% stable_disease ~ \"Stable_Disease\",\n    TRUE ~ NA_character_  # For patients not in any group\n  ))\n\n# Define color mappings\nexpansion_colors &lt;- c(\"Postvax\" = \"#F8766D\", \"Postnivo\" = \"#87CEEB\")\nresponse_colors &lt;- c(\n  \"Progressive\" = \"#E69F00\",\n  \"Transient_Response\" = \"#56B4E9\",\n  \"Stable_Disease\" = \"#009E73\"\n)\n\n\nsig_summary$response &lt;- factor(sig_summary$response, levels=c(\"Transient_Response\", \"Stable_Disease\", \"Progressive\"))\n# Plot with response group as outline color\nggplot(sig_summary, aes(x = patient_id, y = proportion, fill = expansion_type)) +\n  geom_bar(stat = \"identity\", size = 1, position = \"stack\") +\n  labs(\n    title = \"Proportion of Significant Clones (Postvax vs Postnivo)\",\n    x = \"Patient ID\",\n    y = \"Proportion of Significant Clones\",\n    fill = \"Expansion Type\",\n    color = \"Response Group\"\n  ) +\n  scale_fill_manual(values = expansion_colors) +\n  theme_minimal(base_size = 14) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  ylim(0, 1) + facet_grid(~response, scales = \"free_x\", space = \"free_x\")\n\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nℹ Please use `linewidth` instead.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#plotting-number-of-postvax-expanded-and-postnivo-expanded",
    "href": "Visualization.html#plotting-number-of-postvax-expanded-and-postnivo-expanded",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.5 Plotting Number of Postvax Expanded and Postnivo Expanded",
    "text": "3.5 Plotting Number of Postvax Expanded and Postnivo Expanded\n\nsig_summary &lt;- sig_summary %&gt;% mutate(new_category = case_when(\n    expansion_type == \"Postvax\" ~ \"Post_Vaccine_Expanded\",\n    expansion_type == \"Postnivo\" ~ \"Post_Nivo_Expanded\",\n    TRUE ~ expansion_type\n  ))\n\nsig_summary$new_category &lt;- factor(sig_summary$new_category, levels=c(\"Post_Vaccine_Expanded\",\"Post_Nivo_Expanded\"))\n\nsig_summary %&gt;%\n  ggplot(aes(x = patient_id, y = count, fill = response)) +\n  geom_bar(stat = \"identity\", position = position_dodge(width = 0.9)) +  # set dodge width\n  geom_text(aes(label = count), \n            position = position_dodge(width = 0.9), \n            vjust = -0.5,  # move text slightly above the bar\n            size = 4) +\n  facet_wrap(~new_category, scales = \"free_y\") +\n  labs(\n    title = \"Number of Postvaccine and Postnivo Expanded Clones\",\n    x = \"Patient ID\",\n    y = \"Clone Count\",\n    fill = \"Response Group\"\n  ) +\n  scale_fill_manual(\n    values = c(\n      \"Progressive\" = \"#E69F00\",\n      \"Transient_Response\" = \"#56B4E9\",\n      \"Stable_Disease\" = \"#009E73\"\n    )\n  ) +\n  theme_classic(base_size = 14) +\n  theme(\n    strip.text = element_text(face = \"bold\"),\n    axis.text.x = element_text(angle = 45, hjust = 1)\n  )",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#conducting-t-test-for-the-number-of-postvax-expanded-vs-postnivo-expanded.",
    "href": "Visualization.html#conducting-t-test-for-the-number-of-postvax-expanded-vs-postnivo-expanded.",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.6 Conducting t-test for the Number of Postvax Expanded vs Postnivo Expanded.",
    "text": "3.6 Conducting t-test for the Number of Postvax Expanded vs Postnivo Expanded.\n\n# Combine all patient data\nall_counts &lt;- bind_rows(\n  PT122_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT122\"),\n  PT119_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT119\"),\n  PT118_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT118\"),\n  PT117_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT117\"),\n  PT116_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT116\"),\n  PT114_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT114\"),\n  PT113_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT113\"),\n  PT111_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT111\"),\n  PT108_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT108\"),\n  PT106_test_fisher_categorized  %&gt;% mutate(patient_id = \"PT106\")\n)\n\n# Count clonotypes by category and patient\n# Postvax Expanded vs Postnivo Expanded across response groups\nclonotype_counts &lt;- all_counts %&gt;%\n  group_by(patient_id, new_category) %&gt;%\n  summarise(count = n(), .groups = \"drop\")\n\n# Only interested in postvax and postnivo comparison\npaired_data &lt;- clonotype_counts %&gt;%\n  filter(new_category %in% c(\"post_W14(vaccine)_expanded\", \"post_W22(booster+Nivo)_expanded\")) %&gt;%\n  pivot_wider(names_from = new_category, values_from = count) %&gt;%\n  replace_na(list(\n    `post_W14(vaccine)_expanded` = 0,\n    `post_W22(booster+Nivo)_expanded` = 0\n  ))\n\n# Paired t-test\nt_test_result &lt;- t.test(paired_data$`post_W14(vaccine)_expanded`,\n                        paired_data$`post_W22(booster+Nivo)_expanded`,\n                        paired = TRUE)\n\n# Reshape for plotting\nlong_counts_df &lt;- paired_data %&gt;%\n  pivot_longer(\n    cols = c(`post_W14(vaccine)_expanded`, `post_W22(booster+Nivo)_expanded`),\n    names_to = \"Condition\",\n    values_to = \"Significant_Clones\"\n  ) %&gt;%\n  mutate(\n    Condition = recode(Condition,\n      \"post_W14(vaccine)_expanded\" = \"Post_W14(Vaccine)\",\n      \"post_W22(booster+Nivo)_expanded\" = \"Post_W22(Nivo)\"\n    ),\n    Patient = patient_id\n  )\n\n# Annotate patient groups\nprogressive &lt;- c(\"PT111\", \"PT114\", \"PT117\", \"PT113\")\ntransient_response &lt;- c(\"PT106\", \"PT108\", \"PT116\")\nstable_disease &lt;- c(\"PT118\", \"PT119\", \"PT122\")\n\nlong_counts_df &lt;- long_counts_df %&gt;%\n  mutate(response = case_when(\n    Patient %in% progressive ~ \"Progressive\",\n    Patient %in% transient_response ~ \"Transient_Response\",\n    Patient %in% stable_disease ~ \"Stable_Disease\",\n    TRUE ~ NA_character_\n  ))\n\n# Final Plot (faceted by response)\nggplot(long_counts_df, aes(x = Condition, y = Significant_Clones, group = Patient)) +\n  geom_point(aes(color = Patient), size = 3, alpha = 0.6) +\n  geom_line(aes(color = Patient), size = 1, alpha = 0.6) +\n  labs(\n    title = \"Paired t-test of Significant Clones\",\n    subtitle = paste(\"Paired t-test p-value:\", signif(t_test_result$p.value, 3)),\n    x = \"Condition\",\n    y = \"Number of Significant Clones\"\n  ) +\n  facet_wrap(~response, scales = \"free_y\") +\n  theme_minimal(base_size = 14) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#comparing-the-number-of-postvax-clone-counts-separated-by-response-groups",
    "href": "Visualization.html#comparing-the-number-of-postvax-clone-counts-separated-by-response-groups",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.7 Comparing the Number of Postvax Clone Counts Separated by Response Groups",
    "text": "3.7 Comparing the Number of Postvax Clone Counts Separated by Response Groups\n\n# Filter postvax expanded clones\npostvax_counts &lt;- clonotype_counts %&gt;%\n  filter(new_category == \"post_W14(vaccine)_expanded\")\n\n# Label patients by response group\npostvax_counts &lt;- postvax_counts %&gt;%\n  mutate(response_group = case_when(\n    patient_id %in% progressive ~ \"Progressive\",\n    patient_id %in% c(transient_response, stable_disease) ~ \"Non_Progressive\",\n    TRUE ~ NA_character_\n  ))\n\n# Perform unpaired t-test\nunpaired_t &lt;- t.test(count ~ response_group, data = postvax_counts)\n\n# Plot results\nggplot(postvax_counts, aes(x = response_group, y = count, color = response_group)) +\n  geom_boxplot(outlier.shape = NA, alpha = 0.2) +\n  geom_jitter(width = 0.2, size = 3, alpha = 0.6) +\n  labs(\n    title = \"Comparison of Postvax Expanded Clones\",\n    subtitle = paste(\"Unpaired t-test p-value:\", signif(unpaired_t$p.value, 3)),\n    x = \"Response Group\",\n    y = \"Number of Postvax Expanded Clones\"\n  ) +\n  scale_color_manual(values = c(\n    \"Progressive\" = \"#E69F00\",\n    \"Non_Progressive\" = \"#56B4E9\"\n  )) +\n  theme_minimal(base_size = 14)\n\n\n\n\n\n\n\n# Filter postvax expanded clones\npostvax_counts &lt;- clonotype_counts %&gt;%\n  filter(new_category == \"post_W22(booster+Nivo)_expanded\")\n\n# Label patients by response group\npostvax_counts &lt;- postvax_counts %&gt;%\n  mutate(response_group = case_when(\n    patient_id %in% progressive ~ \"Progressive\",\n    patient_id %in% c(transient_response, stable_disease) ~ \"Non_Progressive\",\n    TRUE ~ NA_character_\n  ))\n\n# Perform unpaired t-test\nunpaired_t &lt;- t.test(count ~ response_group, data = postvax_counts)\n\n# Plot results\nggplot(postvax_counts, aes(x = response_group, y = count, color = response_group)) +\n  geom_boxplot(outlier.shape = NA, alpha = 0.2) +\n  geom_jitter(width = 0.2, size = 3, alpha = 0.6) +\n  labs(\n    title = \"Comparison of Postnivo Expanded Clones\",\n    subtitle = paste(\"Unpaired t-test p-value:\", signif(unpaired_t$p.value, 3)),\n    x = \"Response Group\",\n    y = \"Number of Postvax Expanded Clones\"\n  ) +\n  scale_color_manual(values = c(\n    \"Progressive\" = \"#E69F00\",\n    \"Non_Progressive\" = \"#56B4E9\"\n  )) +\n  theme_minimal(base_size = 14)",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#heatmap-to-show-difference-between-postnivo---postvaccine-frequencies-among-postvaccine-expanded-clones",
    "href": "Visualization.html#heatmap-to-show-difference-between-postnivo---postvaccine-frequencies-among-postvaccine-expanded-clones",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.8 Heatmap to Show Difference Between Postnivo - Postvaccine Frequencies (among postvaccine expanded clones)",
    "text": "3.8 Heatmap to Show Difference Between Postnivo - Postvaccine Frequencies (among postvaccine expanded clones)\n\n# color definition function \ncol_fun &lt;- colorRamp2(\n  breaks = c(-0.01, 0, 0.01),\n  colors = c(\"blue\", \"white\", \"red\")\n)\n\nmake_heatmap &lt;- function(df, patient_id) {\n  temp &lt;- df[df$new_category == \"post_W14(vaccine)_expanded\", ]\n  temp &lt;- temp[order(-temp$Postvaccine_umi_fraction), ]\n  # difference in umi_fraction (Postnivo - Postvaccine)\n  temp$diff &lt;- temp$Postnivo_umi_fraction - temp$Postvaccine_umi_fraction\n  temp &lt;- temp[order(-temp$diff), ]\n  mat &lt;- matrix(temp$diff)\n  colnames(mat) &lt;- paste0(\"Patient:\", patient_id)\n  Heatmap(mat, cluster_rows = FALSE, cluster_columns = FALSE, show_row_names = FALSE,col=col_fun, heatmap_legend_param = list(title = \"Nivo-Vax\"))\n}\n\n# Create heatmaps for each patient\np1 &lt;- make_heatmap(PT108_test_fisher_categorized, 108)\np2 &lt;- make_heatmap(PT116_test_fisher_categorized, 116)\np3 &lt;- make_heatmap(PT113_test_fisher_categorized, 113)\np4 &lt;- make_heatmap(PT114_test_fisher_categorized, 114)\np5 &lt;- make_heatmap(PT117_test_fisher_categorized, 117)\np6 &lt;- make_heatmap(PT118_test_fisher_categorized, 118)\np7 &lt;- make_heatmap(PT119_test_fisher_categorized, 119)\np8 &lt;- make_heatmap(PT122_test_fisher_categorized, 122)\n\np1_grid &lt;- grid.grabExpr(draw(p1))\np2_grid &lt;- grid.grabExpr(draw(p2))\np3_grid &lt;- grid.grabExpr(draw(p3))\np4_grid &lt;- grid.grabExpr(draw(p4))\np5_grid &lt;- grid.grabExpr(draw(p5))\np6_grid &lt;- grid.grabExpr(draw(p6))\np7_grid &lt;- grid.grabExpr(draw(p7))\np8_grid &lt;- grid.grabExpr(draw(p8))\n\nplot_grid(p1_grid, p2_grid, p3_grid, p4_grid,p5_grid,p6_grid,p7_grid,p8_grid, ncol=8)",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#plotting-frequency-of-individual-clones",
    "href": "Visualization.html#plotting-frequency-of-individual-clones",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.9 Plotting Frequency of individual clones",
    "text": "3.9 Plotting Frequency of individual clones\n\ndraw_lod_line &lt;- function(yinter) {\n  indiv_lod_line &lt;- geom_hline(yintercept = yinter, linetype = \"dashed\", color = \"red\")\n  return(indiv_lod_line)\n}\n\nplot_frequency &lt;- function(input_df, timepoint_order, p_id) {\n  # Long format for plotting\n  input_df_pivot &lt;- input_df %&gt;%\n    dplyr::select(clonotype_id, contains(\"umi_fraction\")) %&gt;%\n    tidyr::pivot_longer(\n      cols = dplyr::contains(\"umi_fraction\"),\n      names_to = \"Timepoint\",\n      values_to = \"UMI_Fraction\"\n    )\n  \n  input_df_pivot$Timepoint &lt;- factor(input_df_pivot$Timepoint, levels = timepoint_order)\n  input_df_pivot$UMI_Fraction &lt;- input_df_pivot$UMI_Fraction\n  input_df_plot_data &lt;- input_df_pivot %&gt;%\n    left_join(input_df %&gt;% dplyr::select(clonotype_id, new_category), by = \"clonotype_id\")\n  \n  # Count clonotypes per category\n  clone_counts &lt;- input_df %&gt;%\n    count(new_category) %&gt;%\n    deframe()  # turns into a named vector\n  \n  # Create legend labels with counts\n  legend_labels &lt;- c(\n    \"non_expanded\" = paste0(\"non_expanded (n=\", clone_counts[\"non_expanded\"], \")\"),\n    \"post_W14(vaccine)_expanded\" = paste0(\"post_W14(vaccine)_expanded (n=\", clone_counts[\"post_W14(vaccine)_expanded\"], \")\"),\n    \"post_W22(booster+Nivo)_expanded\" = paste0(\"post_W22(booster+Nivo)_expanded (n=\", clone_counts[\"post_W22(booster+Nivo)_expanded\"], \")\")\n  )\n  \n  # Plot\n  p1 &lt;- ggplot(input_df_plot_data, aes(x = Timepoint, y = UMI_Fraction, group = clonotype_id, color = new_category)) +\n    geom_line(data = input_df_plot_data %&gt;% filter(new_category == \"non_expanded\"), \n              aes(color = \"non_expanded\"), size = 1, alpha = 0.5) +\n    geom_line(data = input_df_plot_data %&gt;% filter(new_category == \"post_W14(vaccine)_expanded\"), \n              aes(color = \"post_W14(vaccine)_expanded\"), size = 1, alpha = 0.5) +\n    geom_line(data = input_df_plot_data %&gt;% filter(new_category == \"post_W22(booster+Nivo)_expanded\"), \n              aes(color = \"post_W22(booster+Nivo)_expanded\"), size = 1, alpha = 0.5) +\n    scale_color_manual(\n      values = c(\n        \"non_expanded\" = \"grey90\",\n        \"post_W14(vaccine)_expanded\" = \"darkgoldenrod3\",\n        \"post_W22(booster+Nivo)_expanded\" = \"#0072B2\"\n      ),\n      labels = legend_labels\n    ) +\n    labs(title = paste(\"Clonotype UMI Fraction Across Timepoints\", p_id),\n         x = \"Timepoint\",\n         y = \"UMI Fraction\",\n         color = \"Clone Category\") +\n    annotation_logticks(sides = \"l\") +\n    draw_lod_line(input_df$visualization_LOD[1]) +\n    annotate(\"text\", x = as.numeric(length(timepoint_order)) + 0.25,\n             y = input_df$visualization_LOD[1]*2, label = \"LOD\", size = 4, color = \"red\") +\n    theme_classic(base_size = 15) +\n    theme(\n      axis.text.x = element_text(angle = 45, hjust = 1, size = 8),\n      axis.text.y = element_text(size = 8),\n      axis.title.x = element_text(size = 8, face = \"bold\"),\n      axis.title.y = element_text(size = 8, face = \"bold\"),\n      legend.text = element_text(size = 8),\n      legend.title = element_text(size = 8, face = \"bold\"),\n      plot.title = element_text(size = 10, face = \"bold\", hjust = 0.5),\n      plot.margin = margin(5, 60, 5, 5)\n    ) +\n    scale_y_log10(labels = label_number(accuracy = 0.00001)) + \n    guides(color = guide_legend(override.aes = list(size = 5, alpha = 1)))\n\n  return(p1)\n}",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#plotting-line-frequency-plots-for-each-patient",
    "href": "Visualization.html#plotting-line-frequency-plots-for-each-patient",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.10 Plotting Line Frequency Plots For Each Patient",
    "text": "3.10 Plotting Line Frequency Plots For Each Patient\n\nPT106_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"w16_umi_fraction\")\nPT106_freq &lt;- plot_frequency(PT106_test_fisher_categorized, PT106_timepoint_order, \"(PT106)\")\n\nPT108_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\", \"w40_umi_fraction\")\nPT108_freq &lt;- plot_frequency(PT108_test_fisher_categorized, PT108_timepoint_order, \"(PT108)\")\n\nPT111_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\")\nPT111_freq &lt;- plot_frequency(PT111_test_fisher_categorized, PT111_timepoint_order, \"(PT111)\")\n\nPT113_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\")\nPT113_freq &lt;- plot_frequency(PT113_test_fisher_categorized, PT113_timepoint_order, \"(PT113)\")\n\nPT114_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\")\nPT114_freq &lt;- plot_frequency(PT114_test_fisher_categorized, PT114_timepoint_order, \"(PT114)\")\n\nPT116_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\", \"w40_umi_fraction\")\nPT116_freq &lt;- plot_frequency(PT116_test_fisher_categorized, PT116_timepoint_order, \"(PT116)\")\n\nPT117_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\")\nPT117_freq &lt;- plot_frequency(PT117_test_fisher_categorized, PT117_timepoint_order, \"(PT117)\")\n\nPT118_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\")\nPT118_freq &lt;- plot_frequency(PT118_test_fisher_categorized, PT118_timepoint_order, \"(PT118)\")\n\nPT119_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\")\nPT119_freq &lt;- plot_frequency(PT119_test_fisher_categorized, PT119_timepoint_order, \"(PT119)\")\n\nPT122_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\")\nPT122_freq &lt;- plot_frequency(PT122_test_fisher_categorized, PT122_timepoint_order, \"(PT122)\")",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#plotting-line-plots-groupping-each-response-groups",
    "href": "Visualization.html#plotting-line-plots-groupping-each-response-groups",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.11 Plotting Line Plots, Groupping Each Response Groups",
    "text": "3.11 Plotting Line Plots, Groupping Each Response Groups\n\n# Create plot grids\n#grid1 &lt;- plot_grid(PT111_freq, PT113_freq, PT114_freq, PT117_freq, ncol = 2)\n#grid2 &lt;- plot_grid(PT118_freq, PT119_freq, PT122_freq, ncol = 2)\n#grid3 &lt;- plot_grid(PT106_freq,PT108_freq, PT116_freq, ncol=3)\n\nPT111_freq\n\n\n\n\n\n\n\nPT113_freq\n\n\n\n\n\n\n\nPT114_freq\n\n\n\n\n\n\n\nPT117_freq\n\n\n\n\n\n\n\n\n\nPT118_freq\n\n\n\n\n\n\n\nPT119_freq\n\n\n\n\n\n\n\nPT122_freq\n\n\n\n\n\n\n\n\n\nPT106_freq\n\n\n\n\n\n\n\nPT108_freq\n\n\n\n\n\n\n\nPT116_freq",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#plotting-frequency-mean-of-each-clone-category",
    "href": "Visualization.html#plotting-frequency-mean-of-each-clone-category",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.12 Plotting Frequency Mean of each Clone Category",
    "text": "3.12 Plotting Frequency Mean of each Clone Category\n\n#if there is LATE timepoint, add to the plot as well.\nplot_frequency_mean &lt;- function(input_df, timepoint_order,p_id) {\n  \n  input_df_vis &lt;- input_df\n  \n  # Add new subcategories for Post_Nivo_Expanded\ninput_df_vis &lt;- input_df_vis %&gt;%\n  mutate(PostVaccine_UMI = Postvaccine_umi,  # Adjust to match your actual column name\n         new_category = case_when(\n           new_category == \"post_W14(vaccine)_expanded\" ~ \"Post_Vaccine_Expanded\",\n           new_category == \"post_W22(booster+Nivo)_expanded\" ~ \"Post_Nivo_Expanded\"\n         ))\n\n# Update factor levels for consistent plotting\ninput_df_vis$new_category &lt;- factor(input_df_vis$new_category,\n                                        levels = c(\"Post_Vaccine_Expanded\",                                           \"Post_Nivo_Expanded\"))\n  input_df_long &lt;- input_df_vis %&gt;%\n    dplyr::select(clonotype_id, contains(\"umi_fraction\")) %&gt;%\n    tidyr::pivot_longer(\n      cols = dplyr::contains(\"umi_fraction\"),\n      names_to = \"Timepoint\",\n      values_to = \"UMI_Fraction\"\n    )\n  \n  input_df_long$Timepoint &lt;- factor(input_df_long$Timepoint, levels = timepoint_order)\n  input_df_long$UMI_Fraction &lt;- (input_df_long$UMI_Fraction)\n  \n  input_df_plot_data &lt;- input_df_long %&gt;%\n    left_join(input_df_vis %&gt;% dplyr::select(clonotype_id,response,new_category), by = \"clonotype_id\")\n  \nsummary_data &lt;- input_df_plot_data %&gt;%\n  filter(new_category %in% c(\"Post_Vaccine_Expanded\", \"Post_Nivo_Expanded\")) %&gt;%\n  group_by(new_category, Timepoint) %&gt;%\n  summarise(\n    mean_UMI = mean(UMI_Fraction, na.rm = TRUE),\n    se_UMI = sd(UMI_Fraction, na.rm = TRUE) / sqrt(n()),\n    .groups = \"drop\"\n)\n\n# Plot with geom_ribbon and geom_line for mean ± SE\np1 &lt;- ggplot(summary_data, aes(x = Timepoint, y = mean_UMI, color = new_category, group = new_category, fill = new_category)) +\n  geom_ribbon(aes(ymin = mean_UMI - se_UMI, ymax = mean_UMI + se_UMI), alpha = 0.3, color = NA) +\n  geom_line(size = 1) +\n  labs(title = paste(\"Clusters -\", p_id),\n       x = \"Timepoint\", y = \"Mean UMI Fraction\") +\n  annotation_logticks(sides = \"l\") +\n  draw_lod_line(input_df_vis$visualization_LOD[1]) +\n  annotate(\"text\", x = as.numeric(length(timepoint_order)) + 0.25,\n           y = input_df_vis$visualization_LOD[1]*2, \n           label = \"LOD\", size = 4, color = \"red\") +\n  theme_classic() +\n  scale_y_log10(limits = c(0.0001, 0.1)) +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  scale_fill_manual(values = c(\"Post_Vaccine_Expanded\" = \"lightblue\", \"Post_Nivo_Expanded\" = \"salmon\")) +\n  scale_color_manual(values = c(\"Post_Vaccine_Expanded\" = \"blue\", \"Post_Nivo_Expanded\" = \"red\"))\nreturn(p1)\n}",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#plotting-mean-frequency-plots-for-each-patient",
    "href": "Visualization.html#plotting-mean-frequency-plots-for-each-patient",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.13 Plotting Mean Frequency Plots for each Patient",
    "text": "3.13 Plotting Mean Frequency Plots for each Patient\n\ntwo_timepoint_order &lt;- c(\"Prevaccine_umis_fraction\", \"Postvaccine_umi_fraction\")\np9 &lt;- plot_frequency_mean( PT106_test_fisher_categorized, two_timepoint_order, \"PT106\")\np10 &lt;- plot_frequency_mean(PT111_test_fisher_categorized, two_timepoint_order, \"PT111\")\n\nthree_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\")\np3 &lt;- plot_frequency_mean( PT122_test_fisher_categorized, three_timepoint_order, \"PT122\")\np4 &lt;- plot_frequency_mean(PT119_test_fisher_categorized, three_timepoint_order, \"PT119\")\np5 &lt;- plot_frequency_mean(PT118_test_fisher_categorized, three_timepoint_order, \"PT118\")\n\n\nfour_timepoint_order &lt;- c(\"Prevaccine_umi_fraction\", \"Postvaccine_umi_fraction\", \"Postnivo_umi_fraction\", \"w40_umi_fraction\")\np1 &lt;- plot_frequency_mean( PT108_test_fisher_categorized, four_timepoint_order, \"PT108\")\np2 &lt;- plot_frequency_mean(PT116_test_fisher_categorized, four_timepoint_order, \"PT116\")\n\np6 &lt;- plot_frequency_mean(PT113_test_fisher_categorized, three_timepoint_order, \"PT113\")\np7 &lt;- plot_frequency_mean(PT114_test_fisher_categorized, three_timepoint_order, \"PT114\")\np8 &lt;- plot_frequency_mean(PT117_test_fisher_categorized, three_timepoint_order, \"PT117\")",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#plotting-shannon-diversity-for-each-patient",
    "href": "Visualization.html#plotting-shannon-diversity-for-each-patient",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.14 Plotting Shannon Diversity for each Patient",
    "text": "3.14 Plotting Shannon Diversity for each Patient\n\n#Load in unfiltered dataframe -&gt; consider all clones for diversity calculation\n\nPT106_merged_df &lt;- readRDS(\"./PT106_merged_df.rds\")\nPT108_merged_df &lt;- readRDS(\"./PT108_merged_df.rds\")\nPT111_merged_df &lt;- readRDS(\"./PT111_merged_df.rds\")\nPT113_merged_df &lt;- readRDS(\"./PT113_merged_df.rds\")\nPT114_merged_df &lt;- readRDS( \"./PT114_merged_df.rds\")\nPT116_merged_df &lt;- readRDS(\"./PT116_merged_df.rds\")\nPT117_merged_df &lt;- readRDS(\"./PT117_merged_df.rds\")\nPT118_merged_df &lt;- readRDS(\"./PT118_merged_df.rds\")\nPT119_merged_df &lt;- readRDS(\"./PT119_merged_df.rds\")\nPT122_merged_df &lt;- readRDS(\"./PT122_merged_df.rds\")\n\ncalculate_diversity &lt;- function(data_list, patient_name) {\n  results &lt;- data.frame()\n  \n  for (timepoint in names(data_list)) {\n    umi_vector &lt;- data_list[[timepoint]]\n    if (length(umi_vector) &gt; 1 && sum(umi_vector) &gt; 0) {\n      diversity_val &lt;- diversity(umi_vector, index = \"shannon\") / log10(length(umi_vector))\n    } else {\n      diversity_val &lt;- NA\n    }\n    results &lt;- rbind(results, data.frame(\n      Patient = patient_name,\n      Timepoint = timepoint,\n      Normalized_Shannon = diversity_val\n    ))\n  }\n  return(results)\n}\n\n# Define timepoint lists for each patient\nPT106_list &lt;- list(\n  Prevaccine_umi = PT106_merged_df$Prevaccine_umi,\n  Postvaccine_umi = PT106_merged_df$Postvaccine_umi,\n  w16_umi = PT106_merged_df$w16_umi\n)\n\nPT108_list &lt;- list(\n  Prevaccine_umi = PT108_merged_df$Prevaccine_umi,\n  Postvaccine_umi = PT108_merged_df$Postvaccine_umi,\n  Postnivo_umi = PT108_merged_df$Postnivo_umi,\n  w40_umi = PT108_merged_df$w40_umi\n)\n\nPT111_list &lt;- list(\n  Prevaccine_umi = PT111_merged_df$Prevaccine_umi,\n  Postvaccine_umi = PT111_merged_df$Postvaccine_umi\n)\n\nPT113_list &lt;- list(\n  Prevaccine_umi = PT113_merged_df$Prevaccine_umi,\n  Postvaccine_umi = PT113_merged_df$Postvaccine_umi,\n  Postnivo_umi = PT113_merged_df$Postnivo_umi\n)\n\nPT114_list &lt;- list(\n  Prevaccine_umi = PT114_merged_df$Prevaccine_umi,\n  Postvaccine_umi = PT114_merged_df$Postvaccine_umi,\n  Postnivo_umi = PT114_merged_df$Postnivo_umi\n)\n\nPT116_list &lt;- list(\n  Prevaccine_umi = PT116_merged_df$Prevaccine_umi,\n  Postvaccine_umi = PT116_merged_df$Postvaccine_umi,\n  Postnivo_umi = PT116_merged_df$Postnivo_umi,\n  w40_umi = PT116_merged_df$w40_umi\n)\n\nPT117_list &lt;- list(\n  Prevaccine_umi = PT117_merged_df$Prevaccine_umi,\n  Postvaccine_umi = PT117_merged_df$Postvaccine_umi,\n  Postnivo_umi = PT117_merged_df$Postnivo_umi\n)\n\nPT118_list &lt;- list(\n  Prevaccine_umi = PT118_merged_df$Prevaccine_umi,\n  Postvaccine_umi = PT118_merged_df$Postvaccine_umi,\n  Postnivo_umi = PT118_merged_df$Postnivo_umi\n)\n\nPT119_list &lt;- list(\n  Prevaccine_umi = PT119_merged_df$Prevaccine_umi,\n  Postvaccine_umi = PT119_merged_df$Postvaccine_umi,\n  Postnivo_umi = PT119_merged_df$Postnivo_umi\n)\n\nPT122_list &lt;- list(\n  Prevaccine_umi = PT122_merged_df$Prevaccine_umi,\n  Postvaccine_umi = PT122_merged_df$Postvaccine_umi,\n  Postnivo_umi = PT122_merged_df$Postnivo_umi\n)\n\n# Apply to all patients\nall_diversity &lt;- rbind(\n  calculate_diversity(PT106_list, \"PT106\"),\n  calculate_diversity(PT108_list, \"PT108\"),\n  calculate_diversity(PT111_list, \"PT111\"),\n  calculate_diversity(PT113_list, \"PT113\"),\n  calculate_diversity(PT114_list, \"PT114\"),\n  calculate_diversity(PT116_list, \"PT116\"),\n  calculate_diversity(PT117_list, \"PT117\"),\n  calculate_diversity(PT118_list, \"PT118\"),\n  calculate_diversity(PT119_list, \"PT119\"),\n  calculate_diversity(PT122_list, \"PT122\")\n)",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  },
  {
    "objectID": "Visualization.html#assign-response-groups-to-diversity-object-and-plot",
    "href": "Visualization.html#assign-response-groups-to-diversity-object-and-plot",
    "title": "3  PBMCs: Data Visualization",
    "section": "3.15 Assign Response Groups to Diversity Object and Plot",
    "text": "3.15 Assign Response Groups to Diversity Object and Plot\n\n# Base colors for each response group\nbase_colors &lt;- c(\n  \"Progressive\" = \"#E69F00\",\n  \"Transient_Response\" = \"#56B4E9\",\n  \"Stable_Disease\" = \"#009E73\"\n)\n\n# Define patients per group\nprogressive &lt;- c(\"PT111\", \"PT114\", \"PT117\", \"PT113\")\ntransient_response &lt;- c(\"PT106\", \"PT108\", \"PT116\")\nstable_disease &lt;- c(\"PT118\", \"PT119\", \"PT122\")\n\n# Function to generate shades for a vector of patients\ngenerate_shades &lt;- function(patients, base_color) {\n  n &lt;- length(patients)\n  pal &lt;- scales::gradient_n_pal(c(lighten(base_color, 0.3), base_color, darken(base_color, 0.3)))\n  shades &lt;- pal(seq(0, 1, length.out = n))\n  names(shades) &lt;- patients\n  return(shades)\n}\n\n# Generate color mapping\npatient_colors &lt;- c(\n  generate_shades(progressive, base_colors[\"Progressive\"]),\n  generate_shades(transient_response, base_colors[\"Transient_Response\"]),\n  generate_shades(stable_disease, base_colors[\"Stable_Disease\"])\n)\n\n# Example: assign patient colors to the dataframe\nall_diversity &lt;- all_diversity %&gt;%\n  mutate(patient_color = patient_colors[Patient])\n\n# Add response column\nall_diversity &lt;- all_diversity %&gt;%\n  mutate(response = case_when(\n    Patient %in% progressive ~ \"Progressive\",\n    Patient %in% transient_response ~ \"Transient_Response\",\n    Patient %in% stable_disease ~ \"Stable_Disease\",\n    TRUE ~ NA_character_  # For patients not in any group\n  ))\n\nall_diversity$response  &lt;- gsub(\"_\", \" \", all_diversity$response)\nall_diversity$Timepoint &lt;- gsub(\"_\", \" \", all_diversity$Timepoint)\nall_diversity$Timepoint &lt;- factor(all_diversity$Timepoint, levels= c(\n  \"Prevaccine umi\",\n  \"Postvaccine umi\",\n  \"Postnivo umi\",\n  \"w16 umi\",\n  \"w40 umi\"\n))\n\np3 &lt;- ggplot(all_diversity, aes(\n    x = Timepoint, y = Normalized_Shannon,\n    group = Patient, color = Patient\n  )) +\n  geom_line(alpha = 0.4) +\n  geom_point(size = 2, alpha = 0.8) +\n  facet_wrap(~response, scales=\"free_x\") +\n  theme_classic() +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1)\n  ) +\n  scale_color_manual(values = patient_colors) +  # assign colors manually\n  labs(y = \"Normalized Shannon\")\n\np3\n\n\n\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.3.2 (2023-10-31)\nPlatform: x86_64-pc-linux-gnu (64-bit)\nRunning under: Rocky Linux 8.10 (Green Obsidian)\n\nMatrix products: default\nBLAS/LAPACK: /usr/lib64/libopenblasp-r0.3.15.so;  LAPACK version 3.9.0\n\nlocale:\n [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              \n [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    \n [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   \n [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 \n [9] LC_ADDRESS=C               LC_TELEPHONE=C            \n[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       \n\ntime zone: America/New_York\ntzcode source: system (glibc)\n\nattached base packages:\n[1] grid      stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] colorspace_2.1-1      scales_1.4.0          vegan_2.6-10         \n [4] lattice_0.22-7        permute_0.9-7         ggridges_0.5.6       \n [7] cowplot_1.1.3.9000    ComplexHeatmap_2.18.0 colorRamp2_0.1.0     \n[10] lubridate_1.9.4       forcats_1.0.0         stringr_1.5.1        \n[13] purrr_1.0.4           readr_2.1.5           tidyr_1.3.1          \n[16] tibble_3.2.1          ggplot2_3.5.1         tidyverse_2.0.0      \n[19] dplyr_1.1.4          \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.6        circlize_0.4.16     shape_1.4.6.1      \n [4] rjson_0.2.23        xfun_0.52           htmlwidgets_1.6.4  \n [7] GlobalOptions_0.1.2 tzdb_0.5.0          Cairo_1.6-2        \n[10] vctrs_0.6.5         tools_4.3.2         generics_0.1.3     \n[13] stats4_4.3.2        parallel_4.3.2      cluster_2.1.8.1    \n[16] pkgconfig_2.0.3     Matrix_1.6-5        RColorBrewer_1.1-3 \n[19] S4Vectors_0.40.2    lifecycle_1.0.4     compiler_4.3.2     \n[22] farver_2.1.2        codetools_0.2-20    clue_0.3-66        \n[25] htmltools_0.5.8.1   pillar_1.10.1       crayon_1.5.3       \n[28] MASS_7.3-60.0.1     magick_2.8.6        iterators_1.0.14   \n[31] foreach_1.5.2       nlme_3.1-168        tidyselect_1.2.1   \n[34] digest_0.6.37       stringi_1.8.7       labeling_0.4.3     \n[37] splines_4.3.2       fastmap_1.2.0       cli_3.6.4          \n[40] magrittr_2.0.3      dichromat_2.0-0.1   withr_3.0.2        \n[43] timechange_0.3.0    rmarkdown_2.29      matrixStats_1.5.0  \n[46] png_0.1-8           GetoptLong_1.0.5    hms_1.1.3          \n[49] evaluate_1.0.3      knitr_1.50          IRanges_2.36.0     \n[52] doParallel_1.0.17   mgcv_1.9-3          rlang_1.1.5        \n[55] Rcpp_1.1.0          glue_1.8.0          BiocGenerics_0.48.1\n[58] rstudioapi_0.17.1   jsonlite_2.0.0      R6_2.6.1",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>PBMCs: Data Visualization</span>"
    ]
  }
]